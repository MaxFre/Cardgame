import"./modulepreload-polyfill-3cfb730f.js";import{i as Fe,a as Ne,b as _e,e as Re,_ as Rt}from"./WildIcon-d4f86f38.js";import{f as Ue}from"./OnFieldFrame-3e1ae940.js";const mt={};[["Folk",Fe],["Magical",Ne],["Wild",_e]].forEach(([t,n])=>{const a=new Image;a.src=n,mt[t]=a});const _=2,F=128*_,N=192*_,V=F/2,It=N/2,ge={x:14,y:42,w:228,h:232};function ve(){Ht()}let d={...ge};const Vt={hand:{attack:{x:V+-15*_,y:It+46*_},health:{x:V+14*_,y:It+46*_},mana:{x:27,y:27},name:{x:V,y:30},faction:{x:V,y:62},factionIconSize:56},field:{attack:{x:V+-15*_,y:It+46*_},health:{x:V+14*_,y:It+46*_},mana:{x:27,y:27},name:{x:V,y:30},faction:{x:V,y:62},factionIconSize:56}};function je(){return structuredClone(Vt)}function $t(){Ht()}let Y=je(),K=Y.hand.attack,Q=Y.hand.health,tt=Y.hand.mana,S=Y.hand.name,T=Y.hand.faction;function pe(){const t=Y[p];K=t.attack,Q=t.health,tt=t.mana,S=t.name,T=t.faction}const be={cx:V,cy:156,r:89};function Ee(){Ht()}let w={...be},g=null,k={highlight:"#ffd700",buff:"#22ee66",damage:"#ff3333"};function Ht(){const t=JSON.stringify({statLayout:Y,fieldCircle:w,handArtBox:d,...g?{handLayoutConfig:g}:{},...k?{glowColors:k}:{},...G!==0?{glowInset:G}:{},...Z!==1?{glowWidth:Z}:{}},null,2);fetch("/api/save-layout",{method:"POST",headers:{"Content-Type":"application/json"},body:t}).catch(()=>{})}const ze={common:"#9ca3af",rare:"#60a5fa",epic:"#a855f7",legendary:"#f1c40f"};let ot=null,bt=null,b=null,Wt=!1,p="hand",B={x:0,y:0},J=1;function Xt(){return p==="field"?"fieldArtOffset":"artOffset"}function Gt(){return p==="field"?"fieldArtZoom":"artZoom"}function qe(){B={...c[Xt()]??{x:0,y:0}},J=c[Gt()]??1}function Zt(){B={x:0,y:0},J=1,c[Xt()]={x:0,y:0},c[Gt()]=1}let c=He(),x=on(),W=null,kt="none",G=0,Z=1;ot=new Image;ot.onload=()=>y();ot.onerror=()=>console.warn("Could not load EmptyCard.png");ot.src=Re;bt=new Image;bt.onload=()=>y();bt.onerror=()=>console.warn("Could not load OnFieldFrame.png");bt.src=Ue;const m=document.getElementById("card-canvas"),e=m.getContext("2d"),lt=document.getElementById("f-name"),Jt=document.getElementById("f-mana"),Kt=document.getElementById("f-attack"),Qt=document.getElementById("f-health"),te=document.getElementById("f-desc"),Mt=document.getElementById("f-effect"),et=document.getElementById("f-effect-value"),xe=document.getElementById("effect-value-row"),Tt=document.getElementById("f-death-effect"),nt=document.getElementById("f-death-effect-value"),we=document.getElementById("death-effect-value-row"),Dt=document.getElementById("f-summon-preset"),Ft=document.getElementById("f-death-vfx-preset");(async()=>{try{const t=await fetch("/CreatedCards/vfx-presets.json");if(t.ok){const n=await t.json();for(const[a,o]of Object.entries(n)){if(a.startsWith("_"))continue;const s=()=>{const l=document.createElement("option");return l.value=a,l.textContent=o.name??a,l};Dt.appendChild(s()),Ft.appendChild(s())}}}catch{}})();const zt=document.getElementById("icon-size-slider"),Ie=document.getElementById("icon-size-val"),Pt=document.getElementById("art-input"),at=document.getElementById("art-thumb"),vt=document.getElementById("art-name"),it=document.getElementById("clear-art"),rt=document.getElementById("upload-area"),Ve=document.getElementById("btn-save"),$e=document.getElementById("btn-new"),Ge=document.getElementById("btn-play"),ee=document.getElementById("btn-discard"),Ze=document.getElementById("btn-export"),Je=document.getElementById("btn-import"),St=document.getElementById("import-input"),Ut=document.getElementById("card-grid"),Ke=document.getElementById("card-count"),ut=document.getElementById("save-toast"),Qe=document.getElementById("art-canvas-hint"),Le=document.getElementById("btn-reset-art"),Ce=document.getElementById("btn-view-hand"),ke=document.getElementById("btn-view-field"),Se=document.getElementById("btn-reset-circle"),Be=document.getElementById("btn-reset-hand-art");function R(t,n){return{px:t*(F/m.offsetWidth),py:n*(N/m.offsetHeight)}}function Nt(t,n){const{px:a,py:o}=R(t,n);if(p==="field"){const s=a-w.cx,l=o-w.cy;return s*s+l*l<=w.r*w.r}return a>=d.x&&a<=d.x+d.w&&o>=d.y&&o<=d.y+d.h}const yt=18,Bt=90,At=14,ue=50,he=16;function ne(t,n){const{px:a,py:o}=R(t,n);if(p==="hand"){if(Math.abs(a-S.x)<=Bt&&Math.abs(o-S.y)<=At)return"name";if(Math.abs(a-T.x)<=ue&&Math.abs(o-T.y)<=he)return"faction";const l={x:tt.x-a,y:tt.y-o};if(l.x*l.x+l.y*l.y<=yt*yt)return"mana"}if(p==="field"&&Math.abs(a-T.x)<=ue&&Math.abs(o-T.y)<=he)return"faction";const s={attack:K,health:Q};for(const[l,i]of Object.entries(s)){const r=a-i.x,f=o-i.y;if(r*r+f*f<=yt*yt)return l}return null}const Lt=14;function ae(t,n){if(p!=="field")return null;const{px:a,py:o}=R(t,n),s=a-(w.cx+w.r),l=o-w.cy;if(s*s+l*l<=Lt*Lt)return"edge";const i=a-w.cx,r=o-w.cy;return i*i+r*r<=Lt*Lt?"center":null}const Ct=14;function oe(t,n){if(p!=="hand")return null;const{px:a,py:o}=R(t,n),s=d.x+d.w,l=d.y+d.h,i=a-s,r=o-l;if(i*i+r*r<=Ct*Ct)return"corner";const f=d.x+d.w/2,I=d.y+d.h/2,P=a-f,L=o-I;return P*P+L*L<=Ct*Ct?"center":null}let O=null,H=null,$=null,D=null;m.addEventListener("mouseenter",t=>{const n=oe(t.offsetX,t.offsetY);if(n){m.style.cursor=n==="center"?"move":"nwse-resize";return}const a=ae(t.offsetX,t.offsetY);if(a){m.style.cursor=a==="center"?"move":"ew-resize";return}if(ne(t.offsetX,t.offsetY)){m.style.cursor="grab";return}b&&Nt(t.offsetX,t.offsetY)&&(m.style.cursor="grab")});m.addEventListener("mousemove",t=>{if(D){const{px:n,py:a}=R(t.offsetX,t.offsetY),o=n-D.startPx,s=a-D.startPy;D.type==="center"?(d.x=Math.round(D.baseX+o),d.y=Math.round(D.baseY+s)):(d.w=Math.max(20,Math.round(D.baseW+o)),d.h=Math.max(20,Math.round(D.baseH+s))),y();return}if($){const{px:n,py:a}=R(t.offsetX,t.offsetY);$.type==="center"?(w.cx=Math.round($.baseCx+(n-$.startPx)),w.cy=Math.round($.baseCy+(a-$.startPy))):w.r=Math.max(20,Math.round(Math.hypot(n-w.cx,a-w.cy))),y();return}if(H){const{px:n,py:a}=R(t.offsetX,t.offsetY),{px:o,py:s}=R(H.startX,H.startY),l=H.basePosX+(n-o),i=H.basePosY+(a-s),r=H.stat==="attack"?K:H.stat==="health"?Q:H.stat==="mana"?tt:H.stat==="faction"?T:S;r.x=l,r.y=i,y();return}if(O)B.x=O.baseOffsetX+(t.offsetX-O.startX)*(F/m.offsetWidth),B.y=O.baseOffsetY+(t.offsetY-O.startY)*(N/m.offsetHeight),c[Xt()]={...B},U(),y();else{const n=oe(t.offsetX,t.offsetY);if(n){m.style.cursor=n==="center"?"move":"nwse-resize";return}const a=ae(t.offsetX,t.offsetY);if(a){m.style.cursor=a==="center"?"move":"ew-resize";return}const o=ne(t.offsetX,t.offsetY);m.style.cursor=o||b&&Nt(t.offsetX,t.offsetY)?"grab":"default"}});m.addEventListener("mousedown",t=>{const n=oe(t.offsetX,t.offsetY);if(n){t.preventDefault();const{px:s,py:l}=R(t.offsetX,t.offsetY);D={type:n,startPx:s,startPy:l,baseX:d.x,baseY:d.y,baseW:d.w,baseH:d.h},m.style.cursor=n==="center"?"move":"nwse-resize";return}const a=ae(t.offsetX,t.offsetY);if(a){t.preventDefault();const{px:s,py:l}=R(t.offsetX,t.offsetY);$={type:a,startPx:s,startPy:l,baseCx:w.cx,baseCy:w.cy},m.style.cursor=a==="center"?"move":"ew-resize";return}const o=ne(t.offsetX,t.offsetY);if(o){t.preventDefault();const s=o==="attack"?K:o==="health"?Q:o==="mana"?tt:o==="faction"?T:S;H={stat:o,startX:t.offsetX,startY:t.offsetY,basePosX:s.x,basePosY:s.y},m.style.cursor="grabbing";return}!b||!Nt(t.offsetX,t.offsetY)||(t.preventDefault(),O={startX:t.offsetX,startY:t.offsetY,baseOffsetX:B.x,baseOffsetY:B.y},m.style.cursor="grabbing")});window.addEventListener("mouseup",()=>{if(D){ve(),D=null,m.style.cursor="default";return}if($){Ee(),$=null,m.style.cursor="default";return}if(H){$t(),H=null,m.style.cursor="default";return}O&&(O=null,m.style.cursor="grab")});document.getElementById("btn-reset-stats").addEventListener("click",()=>{const t=structuredClone(Vt[p]);Object.assign(K,t.attack),Object.assign(Q,t.health),Object.assign(tt,t.mana),Object.assign(S,t.name),Object.assign(T,t.faction),$t(),y()});Se.addEventListener("click",()=>{w={...be},Ee(),y()});Be.addEventListener("click",()=>{d={...ge},ve(),y()});m.addEventListener("touchstart",t=>{if(!b)return;const n=t.touches[0],a=m.getBoundingClientRect(),o=n.clientX-a.left,s=n.clientY-a.top;Nt(o,s)&&(t.preventDefault(),O={startX:o,startY:s,baseOffsetX:B.x,baseOffsetY:B.y})},{passive:!1});m.addEventListener("touchmove",t=>{if(!O)return;t.preventDefault();const n=t.touches[0],a=m.getBoundingClientRect();B.x=O.baseOffsetX+(n.clientX-a.left-O.startX)*(F/m.offsetWidth),B.y=O.baseOffsetY+(n.clientY-a.top-O.startY)*(N/m.offsetHeight),c[Xt()]={...B},U(),y()},{passive:!1});m.addEventListener("touchend",()=>{O=null});m.addEventListener("wheel",t=>{if(!b)return;t.preventDefault();const n=t.deltaY>0?-.08:.08;J=Math.min(4,Math.max(.3,J+n)),c[Gt()]=J,U(),y()},{passive:!1});Le.addEventListener("click",()=>{Zt(),U(),y()});function pt(t){Qe.style.display=t?"block":"none",Le.style.display=t?"inline-block":"none"}function Ae(t){p=t,pe(),qe(),Ce.classList.toggle("active",t==="hand"),ke.classList.toggle("active",t==="field"),Se.style.display=t==="field"?"":"none",Be.style.display=t==="hand"?"":"none";const n=document.getElementById("field-circle-hint");n&&(n.style.display=t==="field"?"":"none");const a=document.getElementById("hand-art-hint");a&&(a.style.display=t==="hand"?"":"none"),y()}Ce.addEventListener("click",()=>Ae("hand"));ke.addEventListener("click",()=>Ae("field"));function y(){if(e.clearRect(0,0,F,N),b){if(e.save(),p==="field"){const{cx:s,cy:l,r:i}=w;e.beginPath(),e.arc(s,l,i,0,Math.PI*2),e.clip();const r=i*2,f=i*2,P=Math.max(r/b.naturalWidth,f/b.naturalHeight)*J,L=b.naturalWidth*P,A=b.naturalHeight*P,st=s-i+(r-L)/2+B.x,dt=l-i+(f-A)/2+B.y;e.drawImage(b,st,dt,L,A)}else{gt(e,d.x,d.y,d.w,d.h,4),e.clip();const l=Math.max(d.w/b.naturalWidth,d.h/b.naturalHeight)*J,i=b.naturalWidth*l,r=b.naturalHeight*l,f=d.x+(d.w-i)/2+B.x,I=d.y+(d.h-r)/2+B.y;e.drawImage(b,f,I,i,r)}e.restore()}const t=p==="field"?bt:ot,n=kt!=="none",a={highlight:(k==null?void 0:k.highlight)||"#ffd700",buff:(k==null?void 0:k.buff)||"#22ee66",damage:(k==null?void 0:k.damage)||"#ff3333"};if(n&&p==="field"&&me(a[kt],G,Z),t&&e.drawImage(t,0,0,F,N),n&&p!=="field"&&me(a[kt],G,Z),p==="field"){const{cx:s,cy:l,r:i}=w;e.save(),e.strokeStyle="rgba(255,255,255,0.55)",e.lineWidth=1.5,e.setLineDash([5,4]),e.beginPath(),e.arc(s,l,i,0,Math.PI*2),e.stroke(),e.setLineDash([]),e.strokeStyle="rgba(255,255,255,0.9)",e.lineWidth=2,e.beginPath(),e.moveTo(s-9,l),e.lineTo(s+9,l),e.moveTo(s,l-9),e.lineTo(s,l+9),e.stroke(),e.beginPath(),e.arc(s+i,l,7,0,Math.PI*2),e.fillStyle="rgba(255,255,255,0.9)",e.fill(),e.strokeStyle="rgba(0,0,0,0.6)",e.lineWidth=1.5,e.stroke(),e.restore()}if(p==="hand"){const{x:s,y:l,w:i,h:r}=d,f=s+i/2,I=l+r/2;e.save(),e.strokeStyle="rgba(255,255,255,0.55)",e.lineWidth=1.5,e.setLineDash([5,4]),e.strokeRect(s,l,i,r),e.setLineDash([]),e.strokeStyle="rgba(255,255,255,0.9)",e.lineWidth=2,e.beginPath(),e.moveTo(f-9,I),e.lineTo(f+9,I),e.moveTo(f,I-9),e.lineTo(f,I+9),e.stroke(),e.beginPath(),e.arc(s+i,l+r,7,0,Math.PI*2),e.fillStyle="rgba(255,255,255,0.9)",e.fill(),e.strokeStyle="rgba(0,0,0,0.6)",e.lineWidth=1.5,e.stroke(),e.restore()}if(p==="hand"){const s=S.x,l=S.y;if(e.save(),e.strokeStyle="#ffd700",e.globalAlpha=.4,e.lineWidth=1.5,e.setLineDash([4,4]),e.strokeRect(s-Bt,l-At,Bt*2,At*2),e.restore(),c.name){const i=Bt*2-8;e.save(),e.textAlign="center",e.textBaseline="middle";let r=26;for(e.font=`bold ${r}px Georgia, serif`;e.measureText(c.name).width>i&&r>11;)r--,e.font=`bold ${r}px Georgia, serif`;e.strokeStyle="rgba(0,0,0,0.95)",e.lineWidth=4,e.lineJoin="round",e.miterLimit=2,e.shadowColor="rgba(0,0,0,0.0)",e.strokeText(c.name,s,l);const f=e.createLinearGradient(s,l-r/2,s,l+r/2);f.addColorStop(0,"#ffe98a"),f.addColorStop(.45,"#ffd700"),f.addColorStop(1,"#c8860a"),e.fillStyle=f,e.shadowColor="rgba(0,0,0,0.85)",e.shadowBlur=6,e.shadowOffsetX=0,e.shadowOffsetY=2,e.fillText(c.name,s,l),e.restore()}}const o=p==="field"?[{key:"attack",pos:K,label:String(c.attack),color:"#f97316"},{key:"health",pos:Q,label:String(c.health),color:"#ef4444"}]:[{key:"attack",pos:K,label:String(c.attack),color:"#f97316"},{key:"health",pos:Q,label:String(c.health),color:"#ef4444"},{key:"mana",pos:tt,label:String(c.manaCost),color:"#60a5fa"}];for(const s of o)e.save(),e.strokeStyle=s.color,e.globalAlpha=.45,e.lineWidth=1.5,e.setLineDash([3,3]),e.beginPath(),e.arc(s.pos.x,s.pos.y,yt,0,Math.PI*2),e.stroke(),e.restore(),tn(e,s.label,s.pos.x,s.pos.y,s.color);if(p==="hand"){const s=ze[c.rarity]||"#9ca3af";e.save(),e.beginPath(),e.arc(S.x,S.y+At+4,4,0,Math.PI*2),e.fillStyle=s,e.shadowColor=s,e.shadowBlur=10,e.fill(),e.restore();const l=Y[p].factionIconSize??40;e.save(),e.strokeStyle="#c084fc",e.globalAlpha=.5,e.lineWidth=1.5,e.setLineDash([3,3]),e.beginPath(),e.arc(T.x,T.y,l/2+4,0,Math.PI*2),e.stroke(),e.restore();const i=mt[c.faction]??mt.Folk;i&&i.complete&&i.naturalWidth>0?e.drawImage(i,T.x-l/2,T.y-l/2,l,l):i&&(i.onload=()=>y())}if(p==="field"){const s=Y.field.factionIconSize??40;e.save(),e.strokeStyle="#c084fc",e.globalAlpha=.5,e.lineWidth=1.5,e.setLineDash([3,3]),e.beginPath(),e.arc(T.x,T.y,s/2+4,0,Math.PI*2),e.stroke(),e.restore();const l=mt[c.faction]??mt.Folk;l&&l.complete&&l.naturalWidth>0?e.drawImage(l,T.x-s/2,T.y-s/2,s,s):l&&(l.onload=()=>y())}}function tn(t,n,a,o,s="#ffffff"){t.save(),t.font="bold 28px 'Impact', 'Arial Black', sans-serif",t.textAlign="center",t.textBaseline="middle",t.lineJoin="round",t.strokeStyle="rgba(0,0,0,0.95)",t.lineWidth=5,t.shadowColor="rgba(0,0,0,0)",t.strokeText(n,a,o),t.fillStyle="#ffffff",t.shadowColor=s,t.shadowBlur=10,t.shadowOffsetX=0,t.shadowOffsetY=0,t.fillText(n,a,o),t.restore()}function me(t,n,a=1){if(p==="field"){const{cx:f,cy:I,r:P}=w,L=Math.max(1,P-n),A=a;e.save(),e.strokeStyle=t,e.shadowColor=t,e.shadowBlur=18*A,e.lineWidth=4*A,e.globalAlpha=1,e.beginPath(),e.arc(f,I,L,0,Math.PI*2),e.stroke(),e.shadowBlur=10*A,e.lineWidth=8*A,e.globalAlpha=.55,e.beginPath(),e.arc(f,I,Math.max(1,L-2),0,Math.PI*2),e.stroke(),e.shadowBlur=5*A,e.lineWidth=14*A,e.globalAlpha=.22,e.beginPath(),e.arc(f,I,Math.max(1,L-6),0,Math.PI*2),e.stroke(),e.restore();return}const o=n,s=Math.max(3,16-o*.4),l=a;e.save(),e.strokeStyle=t,e.shadowColor=t,e.shadowBlur=18*l,e.lineWidth=4*l,e.globalAlpha=1,gt(e,o,o,F-o*2,N-o*2,s),e.stroke();const i=o+2;e.shadowBlur=10*l,e.lineWidth=8*l,e.globalAlpha=.55,gt(e,i,i,F-i*2,N-i*2,Math.max(2,s-1)),e.stroke();const r=o+6;e.shadowBlur=5*l,e.lineWidth=14*l,e.globalAlpha=.22,gt(e,r,r,F-r*2,N-r*2,Math.max(1,s-2)),e.stroke(),e.restore()}function gt(t,n,a,o,s,l){t.beginPath(),t.moveTo(n+l,a),t.lineTo(n+o-l,a),t.quadraticCurveTo(n+o,a,n+o,a+l),t.lineTo(n+o,a+s-l),t.quadraticCurveTo(n+o,a+s,n+o-l,a+s),t.lineTo(n+l,a+s),t.quadraticCurveTo(n,a+s,n,a+s-l),t.lineTo(n,a+l),t.quadraticCurveTo(n,a,n+l,a),t.closePath()}function en(t,n){const o=F*.75,s=N*.75,l=document.createElement("canvas");l.width=o,l.height=s;const i=l.getContext("2d");if(i.scale(.75,.75),n){i.save(),gt(i,d.x,d.y,d.w,d.h,4),i.clip();const r=t.artOffset??{x:0,y:0},f=t.artZoom??1,P=Math.max(d.w/n.naturalWidth,d.h/n.naturalHeight)*f,L=n.naturalWidth*P,A=n.naturalHeight*P,st=d.x+(d.w-L)/2+r.x,dt=d.y+(d.h-A)/2+r.y;i.drawImage(n,st,dt,L,A),i.restore()}if(ot&&i.drawImage(ot,0,0,F,N),t.name){i.save(),i.textAlign="center",i.textBaseline="middle";let r=18;for(i.font=`bold ${r}px Georgia, serif`;i.measureText(t.name).width>190&&r>9;)r--,i.font=`bold ${r}px Georgia, serif`;i.strokeStyle="rgba(0,0,0,0.95)",i.lineWidth=3,i.lineJoin="round",i.strokeText(t.name,S.x,S.y);const f=i.createLinearGradient(S.x,S.y-r/2,S.x,S.y+r/2);f.addColorStop(0,"#ffe98a"),f.addColorStop(.5,"#ffd700"),f.addColorStop(1,"#c8860a"),i.fillStyle=f,i.shadowColor="rgba(0,0,0,0.8)",i.shadowBlur=4,i.fillText(t.name,S.x,S.y),i.restore()}return jt(i,String(t.attack),K.x,K.y,"#f97316"),jt(i,String(t.health),Q.x,Q.y,"#ef4444"),jt(i,String(t.manaCost),tt.x,tt.y,"#60a5fa"),l}function jt(t,n,a,o,s="#ffffff"){t.save(),t.font="bold 22px 'Impact', 'Arial Black', sans-serif",t.textAlign="center",t.textBaseline="middle",t.lineJoin="round",t.strokeStyle="rgba(0,0,0,0.95)",t.lineWidth=4,t.shadowColor="rgba(0,0,0,0)",t.strokeText(n,a,o),t.fillStyle="#ffffff",t.shadowColor=s,t.shadowBlur=8,t.shadowOffsetX=0,t.shadowOffsetY=0,t.fillText(n,a,o),t.restore()}function M(){c.name=lt.value.trim(),c.manaCost=ht(Jt.value,0,20),c.attack=ht(Kt.value,0,20),c.health=ht(Qt.value,1,30),c.description=te.value.trim();const t=Mt.value;t?c.onPlayEffect={id:t,value:ht(et.value,1,20)}:c.onPlayEffect=null;const n=Tt.value;n?c.deathEffect={id:n,value:ht(nt.value,1,20)}:c.deathEffect=null,c.summonVfxPreset=Dt.value||null,c.deathVfxPreset=Ft.value||null,U(),y()}function se(t){lt.value=t.name??"",Jt.value=t.manaCost??1,Kt.value=t.attack??1,Qt.value=t.health??1,te.value=t.description??"";const n=t.onPlayEffect;Mt.value=(n==null?void 0:n.id)??"",et.value=(n==null?void 0:n.value)??3,xe.style.display=n!=null&&n.id?"block":"none";const a=t.deathEffect;Tt.value=(a==null?void 0:a.id)??"",nt.value=(a==null?void 0:a.value)??2,we.style.display=a!=null&&a.id?"block":"none",Dt.value=t.summonVfxPreset??"",Ft.value=t.deathVfxPreset??"",Me(t.type??"minion"),Te(t.rarity??"common"),Pe(t.faction??"Folk"),nn()}[lt,te].forEach(t=>t.addEventListener("input",M));[Jt,Kt,Qt].forEach(t=>{t.addEventListener("input",M),t.addEventListener("change",M)});Mt.addEventListener("change",()=>{xe.style.display=Mt.value?"block":"none",M()});et.addEventListener("input",M);et.addEventListener("change",M);document.getElementById("effect-val-minus").addEventListener("click",()=>{et.value=Math.max(1,Number(et.value)-1),M()});document.getElementById("effect-val-plus").addEventListener("click",()=>{et.value=Math.min(20,Number(et.value)+1),M()});Tt.addEventListener("change",()=>{we.style.display=Tt.value?"block":"none",M()});nt.addEventListener("input",M);nt.addEventListener("change",M);document.getElementById("death-effect-val-minus").addEventListener("click",()=>{nt.value=Math.max(1,Number(nt.value)-1),M()});document.getElementById("death-effect-val-plus").addEventListener("click",()=>{nt.value=Math.min(20,Number(nt.value)+1),M()});Dt.addEventListener("change",M);Ft.addEventListener("change",M);document.querySelectorAll(".stat-spinner button").forEach(t=>{t.addEventListener("click",()=>{const n=t.dataset.stat,a=Number(t.dataset.dir),o=document.getElementById(`f-${n}`),s=Number(o.min),l=Number(o.max);o.value=Math.min(l,Math.max(s,Number(o.value)+a)),M()})});document.getElementById("type-row").addEventListener("click",t=>{const n=t.target.closest(".type-btn");n&&(Me(n.dataset.type),c.type=n.dataset.type,U())});function Me(t){document.querySelectorAll(".type-btn").forEach(n=>{n.classList.toggle("active",n.dataset.type===t)})}document.getElementById("rarity-row").addEventListener("click",t=>{const n=t.target.closest(".rarity-btn");n&&(Te(n.dataset.rarity),c.rarity=n.dataset.rarity,U(),y())});function Te(t){document.querySelectorAll(".rarity-btn").forEach(n=>{n.classList.toggle("active",n.dataset.rarity===t)})}document.getElementById("faction-row").addEventListener("click",t=>{const n=t.target.closest(".faction-btn");n&&(Pe(n.dataset.faction),c.faction=n.dataset.faction,U(),y())});function Pe(t){document.querySelectorAll(".faction-btn").forEach(n=>{n.classList.toggle("active",n.dataset.faction===t)})}zt.addEventListener("input",()=>{const t=Number(zt.value);Ie.textContent=t,Y.hand.factionIconSize=t,Y.field.factionIconSize=t,$t(),y()});function nn(){var n;const t=((n=Y[p])==null?void 0:n.factionIconSize)??40;zt.value=t,Ie.textContent=t}Pt.addEventListener("change",()=>{const t=Pt.files[0];t&&Oe(t)});rt.addEventListener("dragover",t=>{t.preventDefault(),rt.classList.add("drag-over")});rt.addEventListener("dragleave",()=>rt.classList.remove("drag-over"));rt.addEventListener("drop",t=>{t.preventDefault(),rt.classList.remove("drag-over");const n=t.dataTransfer.files[0];n&&n.type.startsWith("image/")&&Oe(n)});function Oe(t){const n=new FileReader;n.onload=a=>{c.artDataUrl=a.target.result,Zt(),b=new Image,b.onload=()=>{at.src=c.artDataUrl,at.style.display="block",it.style.display="inline",vt.textContent=t.name,pt(!0),U(),y()},b.src=c.artDataUrl},n.readAsDataURL(t)}it.addEventListener("click",()=>{c.artDataUrl=null,b=null,Pt.value="",at.style.display="none",it.style.display="none",vt.textContent="No image selected",Zt(),pt(!1),U(),y()});Ve.addEventListener("click",()=>{if(M(),!c.name){lt.focus(),lt.style.borderColor="#ef4444",setTimeout(()=>lt.style.borderColor="",1500);return}if(W!==null){const t=x.findIndex(n=>n.id===W);t!==-1&&(x[t]={...c},ct(),Ot(W))}else c.id=Date.now(),x.push({...c}),W=c.id,ct(),Ot(W);_t(x),Yt(),an(`✔ “${c.name}” saved (${x.length} card${x.length!==1?"s":""} in collection)`)});$e.addEventListener("click",()=>{Wt&&!confirm("Discard unsaved changes?")||le()});Ge.addEventListener("click",()=>{window.location.href="/"});ee.addEventListener("click",()=>{if(W!==null){const t=x.find(n=>n.id===W);if(t){Ye(t);return}}le()});function le(){W=null,c=He(),b=null,B={x:0,y:0},J=1,Pt.value="",at.style.display="none",it.style.display="none",vt.textContent="No image selected",pt(!1),se(c),Yt(),y(),document.querySelectorAll(".card-thumb").forEach(t=>t.classList.remove("active"))}function Ye(t){W=t.id,c={...t},se(c),b=null,B=t[p==="field"?"fieldArtOffset":"artOffset"]?{...t[p==="field"?"fieldArtOffset":"artOffset"]}:{x:0,y:0},J=t[p==="field"?"fieldArtZoom":"artZoom"]??1,t.artDataUrl?(b=new Image,b.onload=()=>{at.src=t.artDataUrl,at.style.display="block",it.style.display="inline",vt.textContent="Saved image",pt(!0),Yt(),y()},b.src=t.artDataUrl):(at.style.display="none",it.style.display="none",vt.textContent="No image selected",pt(!1),Yt(),y())}Ze.addEventListener("click",()=>{const t=x.map(({artDataUrl:i,...r})=>r),a=confirm(`Include card art (base64) in the export?

Yes = full export with images
No = stats only`)?x:t,o=new Blob([JSON.stringify(a,null,2)],{type:"application/json"}),s=URL.createObjectURL(o),l=document.createElement("a");l.href=s,l.download="cards.json",l.click(),URL.revokeObjectURL(s)});Je.addEventListener("click",()=>St.click());St.addEventListener("change",()=>{const t=St.files[0];if(!t)return;const n=new FileReader;n.onload=a=>{try{const o=JSON.parse(a.target.result);if(!Array.isArray(o))throw new Error("Expected array");if(!confirm(`Import ${o.length} card(s)? This will merge with the current collection.`))return;o.forEach(s=>{s.id||(s.id=Date.now()+Math.random()),x.find(l=>l.id===s.id)||x.push(s)}),_t(x),ct()}catch(o){alert("Failed to parse JSON: "+o.message)}},n.readAsText(t),St.value=""});function ct(){if(Ut.innerHTML="",Ke.textContent=x.length,x.length===0){Ut.innerHTML='<span class="empty-collection">No cards yet — create one above!</span>';return}x.forEach(t=>{const n=document.createElement("div");n.className="card-thumb",n.dataset.id=t.id;const a=s=>{const l=n.querySelector("canvas");l&&l.remove();const i=en(t,s);n.insertBefore(i,n.firstChild)};if(t.artDataUrl){const s=new Image;s.onload=()=>a(s),s.src=t.artDataUrl}else a(null);const o=document.createElement("button");o.className="thumb-del",o.title="Delete card",o.textContent="✕",o.addEventListener("click",s=>{s.stopPropagation(),confirm(`Delete "${t.name||"Unnamed"}"?`)&&(x=x.filter(l=>l.id!==t.id),_t(x),W===t.id&&le(),ct())}),n.appendChild(o),n.addEventListener("click",()=>{const s=x.find(l=>l.id===t.id);s&&(Ye(s),Ot(s.id))}),Ut.appendChild(n)}),W!==null&&Ot(W)}function Ot(t){document.querySelectorAll(".card-thumb").forEach(n=>{n.classList.toggle("active",Number(n.dataset.id)===t)})}function U(){Wt=!0,ee.style.display="block"}function Yt(){Wt=!1,ee.style.display="none"}let ye=null;function an(t){ut.textContent=t,ut.style.opacity="1",ut.style.transform="translateX(-50%) translateY(0)",clearTimeout(ye),ye=setTimeout(()=>{ut.style.opacity="0",ut.style.transform="translateX(-50%) translateY(20px)"},2800)}function He(){return{id:null,name:"",type:"minion",faction:"Folk",rarity:"common",description:"",manaCost:1,attack:1,health:1,artDataUrl:null,artOffset:{x:0,y:0},artZoom:1,fieldArtOffset:{x:0,y:0},fieldArtZoom:1,onPlayEffect:null,deathEffect:null}}function ht(t,n,a){return Math.min(a,Math.max(n,Math.round(Number(t)||0)))}function on(){return Array.isArray(Rt)&&Rt.length>0?Rt:[]}async function _t(t){const n=JSON.stringify(t,null,2);try{const o=await fetch("/api/save-collection",{method:"POST",headers:{"Content-Type":"application/json"},body:n});if(o.ok)return;console.warn("save-collection API error",await o.text())}catch(o){console.warn("save-collection request failed:",o)}const a=URL.createObjectURL(new Blob([n],{type:"application/json"}));Object.assign(document.createElement("a"),{href:a,download:"collection.json"}).click(),URL.revokeObjectURL(a)}(async function(){try{const n=await fetch("/CreatedCards/collection.json?t="+Date.now());if(n.ok){const a=await n.json();if(Array.isArray(a)&&a.length>0){x=a,ct();return}}}catch{}x.length>0&&await _t(x)})();window.addEventListener("beforeunload",t=>{Wt&&(t.preventDefault(),t.returnValue="")});se(c);ct();y();(async function(){try{const n=await fetch("/CreatedCards/layout.json?t="+Date.now());if(!n.ok)return;const a=await n.json();if(a.statLayout){const o=s=>{const l=a.statLayout[s]??{},i=Vt[s];return{attack:l.attack??{...i.attack},health:l.health??{...i.health},mana:l.mana??{...i.mana},name:l.name??{...i.name},faction:l.faction??{...i.faction},factionIconSize:l.factionIconSize??i.factionIconSize}};Y={hand:o("hand"),field:o("field")},pe()}a.fieldCircle&&Object.assign(w,a.fieldCircle),a.handArtBox&&Object.assign(d,a.handArtBox),a.handLayoutConfig&&(g=a.handLayoutConfig,qt&&qt()),a.glowColors&&(k=a.glowColors),typeof a.glowInset=="number"&&(G=a.glowInset),typeof a.glowWidth=="number"&&(Z=a.glowWidth),y()}catch{}})();let qt=null;(function(){const t={spacing:145,angle:6,arc:6,hover:30},n=5;g||(g={...t});const a=document.getElementById("hand-canvas"),o=a.getContext("2d"),s=document.getElementById("sl-spacing"),l=document.getElementById("sl-angle"),i=document.getElementById("sl-arc"),r=document.getElementById("sl-hover"),f=document.getElementById("lbl-spacing"),I=document.getElementById("lbl-angle"),P=document.getElementById("lbl-arc"),L=document.getElementById("lbl-hover"),A=65,st=91,dt=a.height/2+20;function ie(){const u=(n-1)/2,h=Math.min(g.spacing,870/Math.max(n-1,1)),E=a.width/2;return Array.from({length:n},(v,C)=>{const X=C-u;return{x:E+X*h,y:dt+Math.abs(X)*g.arc,rot:X*g.angle*Math.PI/180,t:X}})}function We(u,h,E,v,C){o.moveTo(u-E/2+C,h-v/2),o.lineTo(u+E/2-C,h-v/2),o.quadraticCurveTo(u+E/2,h-v/2,u+E/2,h-v/2+C),o.lineTo(u+E/2,h+v/2-C),o.quadraticCurveTo(u+E/2,h+v/2,u+E/2-C,h+v/2),o.lineTo(u-E/2+C,h+v/2),o.quadraticCurveTo(u-E/2,h+v/2,u-E/2,h+v/2-C),o.lineTo(u-E/2,h-v/2+C),o.quadraticCurveTo(u-E/2,h-v/2,u-E/2+C,h-v/2),o.closePath()}function j(){o.clearRect(0,0,a.width,a.height),ie().forEach(({x:u,y:h,rot:E},v)=>{o.save(),o.translate(u,h),o.rotate(E),o.shadowColor="rgba(0,0,0,.55)",o.shadowBlur=12,o.beginPath(),We(0,0,A,st,6),o.fillStyle=`hsl(${215+v*18}, 38%, 22%)`,o.fill(),o.shadowBlur=0,o.strokeStyle="#4f6ef7",o.lineWidth=1.5,o.stroke(),o.fillStyle="#e2e8f0",o.font="bold 14px Segoe UI, system-ui, sans-serif",o.textAlign="center",o.textBaseline="middle",o.fillText(v+1,0,0),o.restore()})}function z(){s.value=g.spacing,l.value=g.angle,i.value=g.arc,r.value=g.hover,f.textContent=`${g.spacing} px`,I.textContent=`${g.angle} °`,P.textContent=`${g.arc} px`,L.textContent=`${g.hover} px`}function Xe(u,h){const E=ie();for(let v=E.length-1;v>=0;v--){const{x:C,y:X,rot:q}=E[v],xt=u-C,wt=h-X,ft=xt*Math.cos(-q)-wt*Math.sin(-q),De=xt*Math.sin(-q)+wt*Math.cos(-q);if(Math.abs(ft)<=A/2&&Math.abs(De)<=st/2)return v}return-1}let Et=-1,re,ce,de,fe;a.addEventListener("mousedown",u=>{const h=a.getBoundingClientRect(),E=a.width/h.width,v=a.height/h.height,C=(u.clientX-h.left)*E,X=(u.clientY-h.top)*v,q=Xe(C,X);q!==-1&&(Et=q,re=C,ce=X,de=g.spacing,fe=g.arc,u.preventDefault())}),window.addEventListener("mousemove",u=>{if(Et===-1)return;const h=a.getBoundingClientRect(),E=a.width/h.width,v=a.height/h.height,C=(u.clientX-h.left)*E,X=(u.clientY-h.top)*v,q=C-re,xt=X-ce,wt=(n-1)/2,ft=Et-wt;Math.abs(ft)>.01&&(g.spacing=Math.round(Math.max(40,Math.min(200,de+q/ft))),g.arc=Math.round(Math.max(0,Math.min(40,fe+xt/Math.abs(ft)))),z(),j())}),window.addEventListener("mouseup",()=>{Et=-1}),a.addEventListener("wheel",u=>{u.preventDefault();const h=u.deltaY>0?-.5:.5;g.angle=Math.max(0,Math.min(20,Math.round((g.angle+h)*2)/2)),z(),j()},{passive:!1}),s.addEventListener("input",()=>{g.spacing=+s.value,z(),j()}),l.addEventListener("input",()=>{g.angle=+l.value,z(),j()}),i.addEventListener("input",()=>{g.arc=+i.value,z(),j()}),r.addEventListener("input",()=>{g.hover=+r.value,z(),j()}),document.getElementById("btn-hand-apply").addEventListener("click",()=>{Ht();const u=document.getElementById("save-toast");u.textContent="✔ Hand layout saved!",u.style.opacity="1",u.style.transform="translateX(-50%) translateY(0)",setTimeout(()=>{u.style.opacity="0",u.style.transform="translateX(-50%) translateY(20px)"},2200)}),document.getElementById("btn-hand-reset").addEventListener("click",()=>{g={...t},z(),j()}),z(),j(),qt=()=>{z(),j()}})();(function(){k||(k={...{highlight:"#ffd700",buff:"#22ee66",damage:"#ff3333"}});const a=document.getElementById("glow-highlight"),o=document.getElementById("glow-buff"),s=document.getElementById("glow-damage");if(!a)return;a.value=k.highlight,o.value=k.buff,s.value=k.damage;function l(){k={highlight:a.value,buff:o.value,damage:s.value},y()}a.addEventListener("input",l),o.addEventListener("input",l),s.addEventListener("input",l);const i=document.getElementById("glow-inset"),r=document.getElementById("glow-inset-val");i&&(i.value=G,r.textContent=G+" px",i.addEventListener("input",()=>{G=parseFloat(i.value),r.textContent=G+" px",y()}));const f=document.getElementById("glow-width"),I=document.getElementById("glow-width-val");f&&(f.value=Z,I.textContent=Z.toFixed(1)+"×",f.addEventListener("input",()=>{Z=parseFloat(f.value),I.textContent=Z.toFixed(1)+"×",y()}));const P=document.querySelectorAll(".glow-prev-btn");P.forEach(L=>{L.addEventListener("click",()=>{P.forEach(A=>A.style.opacity="0.55"),L.style.opacity="1",kt=L.dataset.mode,y()})})})();
