import"./modulepreload-polyfill-3cfb730f.js";import{T as rt,C as z,G as H,M as Ye,S as We,a as Lt,b as O,c as Kt,d as R,B as Ea,e as Pa,L as Ma,f as Ia,g as Yt,h as te,A as Ha,i as Ra}from"./BoardForrest-927fe922.js";import{_ as qe,e as Da,i as $e,a as Oa,b as Ga}from"./WildIcon-d4f86f38.js";import{f as Ba}from"./OnFieldFrame-3e1ae940.js";import{c as ma}from"./CardBack-419d7a67.js";import{t as S,c as V,a as Xa,b as xa,V as Na}from"./VFX-c64be62e.js";import{S as M}from"./SoundManager-7983c1fd.js";import{A as Ue,c as za}from"./AnimationSequencer-d646b041.js";function Ya(a,t){return a===t?0:a==="Magical"&&t==="Folk"||a==="Wild"&&t==="Magical"||a==="Folk"&&t==="Wild"?1:-1}class N{constructor(t,e=0,i=0,s=0,n={}){this.id=t,this.manaCost=e,this.attack=i,this.health=s,this.name=n.name??"",this.type=n.type??"minion",this.faction=n.faction??"Folk",this.rarity=n.rarity??"common",this.description=n.description??"",this.artDataUrl=n.artDataUrl??null,this.artOffset=n.artOffset??{x:0,y:0},this.artZoom=n.artZoom??1,this.fieldArtOffset=n.fieldArtOffset??null,this.fieldArtZoom=n.fieldArtZoom??null,this.onPlayEffect=n.onPlayEffect??null,this.deathEffect=n.deathEffect??null,this.summonVfxPreset=n.summonVfxPreset??null,this.deathVfxPreset=n.deathVfxPreset??null}static loadFromStorage(t=15){try{const e=qe.length>0?qe:[];return e.length===0?N.createTestCards(t):[...e,...e].sort(()=>Math.random()-.5).map((s,n)=>new N(s.id??n,s.manaCost??1,s.attack??1,s.health??1,s))}catch{return N.createTestCards(t)}}static async syncFromFile(){}static typeMultiplier(t,e){return Ya(t??"Folk",e??"Folk")}static createTestCards(t){const e=["Magical","Wild","Folk"];return Array.from({length:t},(i,s)=>new N(s,Math.ceil(Math.random()*10),Math.ceil(Math.random()*10),Math.ceil(Math.random()*10),{faction:e[s%3]}))}}const st=128,nt=192;let le={x:-15,y:46},oe={x:14,y:46},re={x:0,y:-81},he={x:-50,y:-83},ce={x:0,y:-65},de={x:-15,y:46},fe={x:14,y:46},ue={x:0,y:-65};const I={x:7,y:21,w:114,h:116};function Wa(){return I.x+I.w/2-st/2}function qa(){return I.y+I.h/2-nt/2}const lt={cx:0,cy:-18,r:44},Me={size:28};let ba={highlight:16766720,buff:2289254,damage:16724787,inset:0,width:1};function $a(a,t,e){const i=s=>parseInt((s||"").replace("#",""),16);ba={highlight:i(a==null?void 0:a.highlight)||16766720,buff:i(a==null?void 0:a.buff)||2289254,damage:i(a==null?void 0:a.damage)||16724787,inset:(t??0)/2,width:e??1}}const Pt=rt.from(Da),we=rt.from(Ba),Ce=rt.from(ma);class Ft extends z{constructor(t){super(),this.card=t,this.eventMode="static",this.cursor="pointer",this.sortableChildren=!0,this._draw()}_draw(){if(this._isField=!1,this.card.artDataUrl){const d=new z;d.zIndex=0,this._artContainer=d;const c=new H;c.beginFill(16777215),c.drawRect(I.x-st/2,I.y-nt/2,I.w,I.h),c.endFill(),d.mask=c,d.addChild(c),this._artMask=c;const y=rt.from(this.card.artDataUrl);y.baseTexture.mipmap=Ye.ON,y.baseTexture.scaleMode=We.LINEAR;const T=new Lt(y);T.anchor.set(.5),this._artSprite=T,this._artTexture=y;const x=new H;x.beginFill(1118481,1),x.drawRect(I.x-st/2,I.y-nt/2,I.w,I.h),x.endFill(),d.addChild(x),this._artBg=x;const k=()=>this._reapplyArt(this._isField);y.baseTexture.valid?k():y.baseTexture.once("loaded",k),d.addChild(T),this.addChild(d)}this._sprite=new Lt(Pt),this._sprite.anchor.set(.5),this._sprite.zIndex=1;const t=()=>{this._sprite.width=st,this._sprite.height=nt};Pt.baseTexture.valid?t():Pt.baseTexture.once("loaded",t),this.addChild(this._sprite);const e={fontFamily:'"Impact", "Arial Black", sans-serif',fontSize:14,fontWeight:"bold",fill:16777215,stroke:0,strokeThickness:3,dropShadow:!0,dropShadowDistance:0,dropShadowBlur:5,dropShadowAlpha:.9},i=new O({...e,dropShadowColor:16347926}),s=new O({...e,dropShadowColor:15680580}),n=new O({...e,dropShadowColor:16096779}),l=new O({fontFamily:"Georgia, serif",fontSize:13,fontWeight:"bold",fill:[16771466,16766720,13141514],fillGradientType:Kt.LINEAR_VERTICAL,stroke:0,strokeThickness:2,dropShadow:!0,dropShadowDistance:1,dropShadowAngle:Math.PI/2,dropShadowBlur:3,dropShadowColor:0,dropShadowAlpha:.85,wordWrap:!0,wordWrapWidth:95,align:"center"});this._nameLabel=new R(this.card.name||"",l),this._nameLabel.anchor.set(.5),this._nameLabel.x=re.x,this._nameLabel.y=re.y,this._nameLabel.zIndex=2,this.addChild(this._nameLabel),this._manaLabel=new R(String(this.card.manaCost??0),n),this._manaLabel.anchor.set(.5),this._manaLabel.x=he.x,this._manaLabel.y=he.y,this._manaLabel.zIndex=2,this.addChild(this._manaLabel);const o={Folk:$e,Magical:Oa,Wild:Ga}[this.card.faction]??$e,h=Ea.from(o,{scaleMode:We.LINEAR,mipmap:Ye.ON}),u=new rt(h);this._factionIcon=new Lt(u),this._factionIcon.anchor.set(.5),this._factionIcon.roundPixels=!1;const _=()=>{this._factionIcon.width=Me.size,this._factionIcon.height=Me.size};u.baseTexture.valid?_():u.baseTexture.once("loaded",_),this._factionIcon.x=ce.x,this._factionIcon.y=ce.y,this._factionIcon.zIndex=2,this._factionIcon.visible=this.card.type!=="spell",this.addChild(this._factionIcon),this._baseAttack=this.card.attack,this._attackStyle=i,this._attackLabel=new R(String(this.card.attack),i),this._attackLabel.anchor.set(.5),this._attackLabel.x=le.x,this._attackLabel.y=le.y,this._attackLabel.zIndex=2,this._attackLabel.visible=!0,this.addChild(this._attackLabel),this._maxHealth=this.card.health,this._healthStyle=s,this._healthLabel=new R(String(this.card.health),s),this._healthLabel.anchor.set(.5),this._healthLabel.x=oe.x,this._healthLabel.y=oe.y,this._healthLabel.zIndex=2,this._healthLabel.visible=!0,this.addChild(this._healthLabel),this.card.type==="spell"&&(this._attackLabel.visible=!1,this._healthLabel.visible=!1),this._glow=new H,this._glow.zIndex=3,this._glow.filters=[new Pa(1.8,4)],this._setGlow(!1),this.addChild(this._glow)}_reapplyArt(t){const e=this._artSprite,i=this._artTexture;if(!e||!i)return;const s=i.width,n=i.height;if(!(!s||!n))if(t){const l=lt.r*2,o=Math.max(l/s,l/n)*(this.card.fieldArtZoom??this.card.artZoom??1);e.width=s*o,e.height=n*o;const h=this.card.fieldArtOffset??this.card.artOffset??{x:0,y:0};e.x=lt.cx+h.x/2,e.y=lt.cy+h.y/2}else{const r=Math.max(I.w/s,I.h/n)*(this.card.artZoom??1);e.width=s*r,e.height=n*r;const o=this.card.artOffset??{x:0,y:0};e.x=Wa()+o.x/2,e.y=qa()+o.y/2}}_drawFactionPill(t,e,i){const s=Math.max(i.length*5,20),n=5,l=11,r=s+n*2,o=l,h=-r/2,u=-o/2,_=o/2;t.clear(),t.beginFill(e,.27),t.lineStyle(1,e,1),t.drawRoundedRect(h,u,r,o,_),t.endFill()}static _loadGlowColors(){return{...ba}}_drawGlowRings(t){const e=this._glow,{inset:i,width:s}=Ft._loadGlowColors(),n=(l,r)=>({width:l*s,color:t,alpha:r,join:Ma.ROUND,cap:Ia.ROUND});if(this._isField){const{cx:l,cy:r,r:o}=lt,h=Math.max(1,o-i);e.lineStyle(n(2,1)),e.drawCircle(l,r,h),e.lineStyle(n(4,.55)),e.drawCircle(l,r,Math.max(1,h-1)),e.lineStyle(n(7,.22)),e.drawCircle(l,r,Math.max(1,h-3))}else{const l=-st/2+i,r=-nt/2+i,o=st-i*2,h=nt-i*2,u=Math.max(2,8-i*.4);e.lineStyle(n(2,1)),e.drawRoundedRect(l,r,o,h,u),e.lineStyle(n(4,.55)),e.drawRoundedRect(l+1,r+1,o-2,h-2,Math.max(1,u-1)),e.lineStyle(n(7,.22)),e.drawRoundedRect(l+3,r+3,o-6,h-6,Math.max(1,u-2))}e.lineStyle(0)}_setGlow(t){this._glow.clear(),t&&this._drawGlowRings(Ft._loadGlowColors().highlight)}setHighlight(t){this._setGlow(t),this._sprite.tint=16777215}setTargetGlow(t,e=null){if(t===this._currentTargetMult&&!e||(this._currentTargetMult=t,this._glow.clear(),this._targetBadge&&(this.removeChild(this._targetBadge),this._targetBadge=null),!t||t===0))return;const s=t>0,n=Ft._loadGlowColors(),l=s?n.buff:n.damage,r=e??(s?"+1":"-1");this._drawGlowRings(l);const o=new z;o.zIndex=10;const h=new H,u=26,_=14,d=7;h.beginFill(l,.85),h.drawRoundedRect(-u/2,-_/2,u,_,d),h.endFill(),o.addChild(h);const c=new R(r,new O({fontFamily:'"Impact", "Arial Black", sans-serif',fontSize:11,fontWeight:"bold",fill:16777215,stroke:0,strokeThickness:2}));c.anchor.set(.5),o.addChild(c),o.x=0,o.y=0,this.addChild(o),this._targetBadge=o}setAttack(t){if(this.card.attack=t,this._attackLabel){this._attackLabel.text=String(t);const e=this._baseAttack;t>e?(this._attackStyle.fill=4521864,this._attackStyle.dropShadowColor=26146):t<e?(this._attackStyle.fill=16729156,this._attackStyle.dropShadowColor=8912896):(this._attackStyle.fill=16777215,this._attackStyle.dropShadowColor=16347926)}}setHealth(t){if(this.card.health=t,this._healthLabel){this._healthLabel.text=String(t);const e=t<this._maxHealth;this._healthStyle.fill=e?16724787:16777215,this._healthStyle.dropShadowColor=e?8912896:15680580}}useFieldFrame(){this._isField=!0,this._sprite.texture=we,this._glow.zIndex=.5,this.sortChildren();const t=()=>{this._sprite.width=st,this._sprite.height=nt};we.baseTexture.valid?t():we.baseTexture.once("loaded",t),this._nameLabel&&(this._nameLabel.visible=!1),this._manaLabel&&(this._manaLabel.visible=!1),this._factionIcon&&(this._factionIcon.visible=this.card.type!=="spell",this._factionIcon.x=ue.x,this._factionIcon.y=ue.y),this._artContainer&&(this._artContainer.visible=!0);const e=this.card.type==="spell";this._attackLabel&&(this._attackLabel.visible=!e),this._healthLabel&&(this._healthLabel.visible=!e),this._artMask&&(this._artMask.clear(),this._artMask.beginFill(16777215),this._artMask.drawCircle(lt.cx,lt.cy,lt.r),this._artMask.endFill()),this._reapplyArt(!0),this._attackLabel&&(this._attackLabel.x=de.x,this._attackLabel.y=de.y),this._healthLabel&&(this._healthLabel.x=fe.x,this._healthLabel.y=fe.y)}useBackFace(){this._sprite.scale.set(1,1),this._sprite.texture=Ce;const t=()=>{this._sprite.width=st,this._sprite.height=nt};Ce.baseTexture.valid?t():Ce.baseTexture.once("loaded",t),this._attackLabel.visible=!1,this._healthLabel.visible=!1,this._nameLabel&&(this._nameLabel.visible=!1),this._manaLabel&&(this._manaLabel.visible=!1),this._factionIcon&&(this._factionIcon.visible=!1),this._artContainer&&(this._artContainer.visible=!1)}useFrontFace(){this._sprite.scale.set(1,1),this._sprite.texture=Pt,this._glow.zIndex=3,this.sortChildren();const t=()=>{this._sprite.width=st,this._sprite.height=nt};Pt.baseTexture.valid?t():Pt.baseTexture.once("loaded",t);const e=this.card.type==="spell";this._attackLabel.visible=!e,this._healthLabel.visible=!e,this._nameLabel&&(this._nameLabel.visible=!0),this._manaLabel&&(this._manaLabel.visible=!0),this._factionIcon&&(this._factionIcon.visible=!e),this._artContainer&&(this._artContainer.visible=!0)}}const Ua=""+new URL("DescriptionBox-56746341.png",import.meta.url).href,_e=2,je=st*_e,Ke=nt*_e,Nt=600,wa=220;let et=null,kt=null,W=null,Ht=null,Rt=null,Te=null,ve=null;const ja=400,Ka=120,D={isDragging:!1,init(a){et=a,a.stage.sortableChildren=!0,Qa(a)},preload(a){if(a._previewNode)return;const t=a._previewSnap;if(!t)return;const e=new z;e.zIndex=9e3,e.eventMode="none",e.sortableChildren=!0;const i=10,s=new H;s.beginFill(1708552,.82),s.lineStyle(2,16766720,.7),s.drawRoundedRect(-je/2-i,-Ke/2-i,je+i*2,Ke+i*2,12),s.endFill(),s.zIndex=0;const n=new Ft(t);n.scale.set(_e),n.x=0,n.y=0,n.zIndex=1,Ta(n,_e),e.addChild(s),e.addChild(n),e.x=0,e.y=0,e.alpha=0,e.visible=!0,e._ready=!1,e._snap=t,et.stage.addChild(e),a._previewNode=e;let l=5;const r=()=>{if(--l>0){et.ticker.addOnce(r);return}e._ready=!0,e.visible=!1,e.alpha=1};et.ticker.addOnce(r)},show(a){this.isDragging||!et||(clearTimeout(ve),clearTimeout(Te),Te=setTimeout(()=>this._doShow(a),ja))},_doShow(a){if(this.isDragging||!et)return;const t=a._previewNode;if(!t||!t._ready)return;kt&&kt!==t&&(kt.visible=!1),kt=t;const e=et.screen.width,i=et.screen.height;t.x=e*.18,t.y=i/2,t.visible=!0;const s=t._snap??{};Ht.text=s.name??"",Rt.text=s.description??"",Ca(),W.visible=!0},hide(){clearTimeout(Te),clearTimeout(ve),ve=setTimeout(()=>{kt&&(kt.visible=!1,kt=null),W&&(W.visible=!1)},Ka)}};function Qa(a){W=new z,W.zIndex=9001,W.eventMode="none",W.visible=!1;const t=rt.from(Ua),e=new Lt(t);e.anchor.set(0);const i=()=>{e.width=Nt,e.height=wa};t.baseTexture.valid?i():t.baseTexture.once("loaded",i),W.addChild(e),Ht=new R("",new O({fontFamily:"Georgia, serif",fontSize:28,fontWeight:"bold",fill:[16776168,16766720,13141514],fillGradientType:Kt.LINEAR_VERTICAL,stroke:1707264,strokeThickness:5,dropShadow:!0,dropShadowColor:0,dropShadowBlur:8,dropShadowDistance:2,dropShadowAlpha:.9})),Ht.x=Nt/2,Ht.y=28,Ht.anchor.set(.5,0),W.addChild(Ht),Rt=new R("",new O({fontFamily:"Georgia, serif",fontSize:20,fontStyle:"italic",fill:16116440,stroke:1707264,strokeThickness:3,dropShadow:!0,dropShadowColor:0,dropShadowBlur:6,dropShadowDistance:1,dropShadowAlpha:.85,wordWrap:!0,wordWrapWidth:Nt-80,align:"center",lineHeight:26})),Rt.x=Nt/2,Rt.y=80,Rt.anchor.set(.5,0),W.addChild(Rt),a.stage.addChild(W),window.addEventListener("resize",Ca)}function Ca(){if(!W||!et)return;const a=et.screen.width,t=et.screen.height;W.x=a/2-Nt/2,W.y=t-wa-16}function Ta(a,t){a instanceof R&&(a.resolution=t*(window.devicePixelRatio||1)),a.children&&a.children.forEach(e=>Ta(e,t))}const Qe={spacing:145,angle:6,arc:6,hover:30};let Ie=null,va={},Sa={};function Za(a,t,e){a&&(Ie=a),t&&(va=t),e&&(Sa=e),Gt=De()}function De(){return Ie?{...Qe,...Ie}:{...Qe}}let Gt=De();const Ja="hand-slot-positions",Va="hand-slot-positions-opponent";function ti(a,t=Ja){const e=t===Va?Sa:va,i=e==null?void 0:e[String(a)];return Array.isArray(i)&&i.length===a?i:null}const ei=()=>Gt.hover,ai=()=>Gt.angle,ii=()=>Gt.arc,si=()=>Gt.spacing,ni=870;class Ze extends z{constructor(){super(),this.cards=[],this.sortableChildren=!0,this.slotKey="hand-slot-positions",this.isOpponent=!1}addCard(t){this.cards.push(t),this.addChild(t),this._preloadPreview(t),this._attachHover(t),this.layout()}_preloadPreview(t){this.isOpponent||(!t._previewSnap&&t.card&&(t._previewSnap={...t.card}),D.preload(t))}_attachHover(t){t.on("pointerover",()=>{t._isOnField||t._isFlying||(S(t,{y:(t._baseY??t.y)-ei()},120),S(t.scale,{x:1.2,y:1.2},120),!this.isOpponent&&!D.isDragging&&D.show(t))}),t.on("pointerout",()=>{t._isOnField||t._isFlying||(S(t,{y:t._baseY??t.y},150),S(t.scale,{x:1,y:1},150),this.isOpponent||D.hide())})}insertCard(t,e){const i=Math.max(0,Math.min(e,this.cards.length));this.cards.splice(i,0,t),this.addChild(t),this._preloadPreview(t),this._attachHover(t),this.layout()}removeCard(t){const e=this.cards.indexOf(t);e!==-1&&(this.cards.splice(e,1),this.removeChild(t),t._laid=!1,this.layout())}layout(){Gt=De();const t=this.cards.length;if(t===0)return;const e=ti(t,this.slotKey);if(e){this.cards.forEach((n,l)=>{const r=e[l]??{x:0,y:0,r:0},o=!n._laid;n._laid=!0,n.zIndex=l,n._baseY=r.y??0,o?(n.x=r.x,n.y=n._baseY,n.rotation=r.r??0):S(n,{x:r.x,y:n._baseY,rotation:r.r??0,alpha:1},180)});return}const i=Math.min(si(),ni/Math.max(t-1,1)),s=(t-1)/2;this.cards.forEach((n,l)=>{const r=l-s,o=!n._laid;n._laid=!0,n.zIndex=l,n._baseY=Math.abs(r)*ii();const h=r*i,u=r*ai()*Math.PI/180;o?(n.x=h,n.y=n._baseY,n.rotation=u):S(n,{x:h,y:n._baseY,rotation:u,alpha:1},180)})}}const li=128,Je=192,Xt=8,Ve=2,Se=rt.from(ma);class ta extends z{constructor(t){super(),this.isPlayer=t,this._layers=[];for(let e=0;e<Xt;e++){const i=new Lt(Se);i.anchor.set(.5);const s=()=>{i.width=li,i.height=Je};Se.baseTexture.valid?s():Se.baseTexture.once("loaded",s),i.x=(e-(Xt-1))*Ve,i.y=-(e-(Xt-1))*Ve,i.visible=!1,this._layers.push(i),this.addChild(i)}this._countLabel=new R("0",{fontFamily:"Georgia, serif",fontSize:22,fontWeight:"bold",fill:16777215,stroke:0,strokeThickness:4}),this._countLabel.anchor.set(.5),this._countLabel.y=Je/2-16,this.addChild(this._countLabel),this.setCount(0)}setCount(t){this._countLabel.text=String(t);const e=t<=0?0:Math.max(1,Math.min(Xt,Math.ceil(t/4)));this._layers.forEach((i,s)=>{i.visible=s>=Xt-e}),this._countLabel.visible=t>0}}const ke=130,ea=40,oi=5,Mt=1e3,It=210;class aa extends z{constructor(){super(),this.sortableChildren=!0,this._placed=[],this._pendingIndex=0,this._lastPendingIndex=-1,this.onCardLanded=null,this.onCardPlaced=null,this.onCardRemoved=null,this._vfx=null,this._buildHitArea()}get isFull(){return this._placed.length>=oi}setVFX(t){this._vfx=t}_buildHitArea(){const t=new H;t.beginFill(16777215,.01),t.drawRoundedRect(-Mt/2,-It/2,Mt,It,10),t.endFill(),this.addChild(t),this._ghost={visible:!1,x:0,y:0}}_positions(t){const i=-(t*ke+(t-1)*ea)/2+ke/2;return Array.from({length:t},(s,n)=>i+n*(ke+ea))}_relayout(){const t=this._positions(this._placed.length);this._placed.forEach(({cardView:e},i)=>{e.x=t[i],e.y=0,e.rotation=0})}async removeCardAnimated(t,e){if(!e){this.removeCard(t);return}if(this._placed.findIndex(n=>n.cardView===t)===-1)return;const s=t.toGlobal({x:0,y:0});M.play("death"),await Promise.all([S(t,{alpha:0},350),e.playDeathEffect(t.card,s.x,s.y)]),t.alpha=1,this.removeCard(t)}removeCard(t){var s,n;const e=this._placed.findIndex(l=>l.cardView===t);if(e===-1)return;(s=this.onCardKilled)==null||s.call(this,t),this._placed.splice(e,1),V(t),V(t.scale),this.removeChild(t),t.destroy({children:!0}),(n=this.onCardRemoved)==null||n.call(this,t);const i=this._positions(this._placed.length);this._placed.forEach(({cardView:l},r)=>{S(l,{x:i[r],y:0},300)})}_insertIndexAt(t){const e=this._placed.length;if(e===0)return 0;const i=this._positions(e+1);for(let s=0;s<e;s++){const n=(i[s]+i[s+1])/2;if(t<n)return s}return e}_ghostX(t){return this._positions(this._placed.length+1)[t]}_localPos(t,e){return this.toLocal({x:t,y:e})}isOverField(t,e){if(this.isFull)return!1;const i=this._localPos(t,e);return i.x>=-Mt/2&&i.x<=Mt/2&&i.y>=-It/2&&i.y<=It/2}isOverFieldIgnoreFull(t,e){const i=this._localPos(t,e);return i.x>=-Mt/2&&i.x<=Mt/2&&i.y>=-It/2&&i.y<=It/2}updateHighlight(t,e){if(!this.isOverField(t,e)){this._ghost.visible=!1,this._collapseCards(),this._lastPendingIndex=-1;return}const i=this._localPos(t,e).x,s=this._insertIndexAt(i);if(this._ghost.visible=!1,s===this._lastPendingIndex)return;this._lastPendingIndex=s,this._pendingIndex=s;const n=this._positions(this._placed.length+1);this._placed.forEach(({cardView:l},r)=>{const o=n[r<s?r:r+1];S(l,{x:o,y:0},350)})}clearHighlights(){this._ghost.visible=!1,this._collapseCards(),this._lastPendingIndex=-1}_collapseCards(){if(this._placed.length===0)return;const t=this._positions(this._placed.length);this._placed.forEach(({cardView:e},i)=>{S(e,{x:t[i],y:0},350)})}getSlotAt(t,e){return this.isOverField(t,e)?this:null}placeCard(t,e){var l,r,o;this._ghost.visible=!1,this._lastPendingIndex=-1,t.eventMode="static",t._isOnField=!0,M.play("summon"),this._placed.splice(this._pendingIndex,0,{cardView:t}),this.addChild(t),this._placed.forEach(({cardView:h})=>{V(h),V(h.scale),h.y=0,h.scale.set(1,1)});const i=this._positions(this._placed.length),s=i[this._pendingIndex];return this._placed.forEach(({cardView:h},u)=>{h!==t&&S(h,{x:i[u],y:0},280)}),t.x=s,t.y=-160,t.rotation=0,t.scale.set(1),((l=t.card)==null?void 0:l.summonVfxPreset)||((o=this._vfx)==null?void 0:o.hasFactionPreset((r=t.card)==null?void 0:r.faction))||this._spawnRingBurst(s,0),Xa(t,{x:s,y:12},160).then(async()=>{t.y=0,t.scale.set(1.22,.72);const h=xa(t.scale,{x:1,y:1},280),u=this.onCardLanded?this.onCardLanded(t):Promise.resolve();await Promise.all([h,u])}).then(()=>this._attachHover(t)).then(async()=>{this.onCardPlaced&&await this.onCardPlaced(t)})}_spawnRingBurst(t,e){let s=0;const n=new H;n.x=t,n.y=e,n.zIndex=50,this.addChild(n);const l=Array.from({length:8},()=>{const o=Math.random()*Math.PI*2,h=2.5+Math.random()*2.5,u=new H;return u.beginFill(16773280,1),u.drawCircle(0,0,2.5),u.endFill(),u.x=t,u.y=e,u._vx=Math.cos(o)*h,u._vy=Math.sin(o)*h,this.addChild(u),u}),r=()=>{if(this.destroyed||!this.parent){Yt.shared.remove(r);return}s++;const o=s/30,h=o*90,u=1-o;n.clear(),n.lineStyle(3*(1-o*.7),16766720,u),n.drawCircle(0,0,h),l.forEach(_=>{_.x+=_._vx,_.y+=_._vy,_._vx*=.92,_._vy*=.92,_.alpha=1-o}),s>=30&&(Yt.shared.remove(r),this.destroyed||(this.removeChild(n),l.forEach(_=>this.removeChild(_))),n.destroy(),l.forEach(_=>_.destroy()))};Yt.shared.add(r)}_attachHover(t){t.on("pointerover",()=>{S(t,{y:-20},120),S(t.scale,{x:1.15,y:1.15},120),t._currentTargetMult||t.setHighlight(!0)}),t.on("pointerout",()=>{S(t,{y:0},150),S(t.scale,{x:1,y:1},150),t._currentTargetMult||t.setHighlight(!1)})}}const ri=[{id:"deal_damage_random_enemy",label:"Battlecry: Deal damage to a random enemy",hasValue:!0,defaultValue:3},{id:"deal_damage_all_enemies",label:"Battlecry: Deal X damage to ALL enemies",hasValue:!0,defaultValue:2},{id:"draw_a_card",label:"Battlecry: Draw X cards",hasValue:!0,defaultValue:1},{id:"heal_random_friendly",label:"Battlecry: Heal a random friendly for X",hasValue:!0,defaultValue:3},{id:"gain_morale",label:"Battlecry: Gain X Morale",hasValue:!0,defaultValue:3},{id:"drain_morale",label:"Battlecry: Drain X Morale from opponent",hasValue:!0,defaultValue:3},{id:"gain_ration_this_turn",label:"Spell: Gain X extra Rations this turn",hasValue:!0,defaultValue:2},{id:"spell_gain_morale",label:"Spell: Gain X Morale",hasValue:!0,defaultValue:5},{id:"spell_drain_morale",label:"Spell: Drain X Morale from opponent",hasValue:!0,defaultValue:5},{id:"spell_attack_buff",label:"Spell: Give any minion +X Attack this turn",hasValue:!0,defaultValue:3,requiresTarget:!0,targetAny:!0,isPositive:!0},{id:"spell_attack_debuff",label:"Spell: Give any minion -X Attack this turn",hasValue:!0,defaultValue:3,requiresTarget:!0,targetAny:!0,isPositive:!1},{id:"spell_stat_buff",label:"Spell: Give any minion +X Attack and +X Health this turn",hasValue:!0,defaultValue:2,requiresTarget:!0,targetAny:!0,isPositive:!0},{id:"spell_stat_buff_perm",label:"Spell: Permanently give any minion +X Attack and +X Health",hasValue:!0,defaultValue:2,requiresTarget:!0,targetAny:!0,isPositive:!0},{id:"spell_stat_debuff_perm",label:"Spell: Permanently reduce any minion by -X Attack and -X Health",hasValue:!0,defaultValue:2,requiresTarget:!0,targetAny:!0,isPositive:!1},{id:"spell_damage_all_enemies",label:"Spell: Deal X damage to ALL enemies",hasValue:!0,defaultValue:2},{id:"spell_draw_a_card",label:"Spell: Draw X cards",hasValue:!0,defaultValue:1},{id:"destroy_a_minion",label:"Battlecry: Destroy any minion",hasValue:!1,defaultValue:1,requiresTarget:!0,targetAny:!0,isPositive:!1,targetLabel:"☠"},{id:"spell_destroy_a_minion",label:"Spell: Destroy any minion",hasValue:!1,defaultValue:1,requiresTarget:!0,targetAny:!0,isPositive:!1,targetLabel:"☠"}],mt=Object.fromEntries(ri.map(a=>[a.id,a])),hi=[{id:"deathrattle_damage_all_enemies",label:"Deathrattle: Deal X damage to all enemies",hasValue:!0,defaultValue:2},{id:"deathrattle_buff_random_friendly",label:"Deathrattle: Give a random friendly minion +X Attack and +X Health",hasValue:!0,defaultValue:2}];Object.fromEntries(hi.map(a=>[a.id,a]));async function Dt(a,t,e,i,s,n=null,l=null,r=null,o=null,h=null,u=null,_={}){switch(a){case"deal_damage_random_enemy":return ci(t,i,h,u);case"deal_damage_all_enemies":return He(t,i,h,u);case"heal_random_friendly":return fi(t,e,h);case"gain_morale":M.play("morale"),h&&n&&h.moraleRadial(n,16763904).catch(()=>{}),n&&n.gainMorale(t);return;case"drain_morale":if(M.play("morale"),h&&l&&n&&h.drainOrb(l,n).catch(()=>{}),l)for(let d=0;d<t;d++)l.takeDamage();return;case"gain_ration_this_turn":h&&n&&h.burstAt(...sa(n),16772744,14).catch(()=>{}),r&&r.gainThisTurn(t);return;case"spell_gain_morale":M.play("morale"),h&&n&&h.moraleRadial(n,16763904).catch(()=>{}),n&&n.gainMorale(t);return;case"spell_drain_morale":if(M.play("morale"),h&&l&&n&&h.drainOrb(l,n).catch(()=>{}),l)for(let d=0;d<t;d++)l.takeDamage();return;case"spell_attack_buff":if(M.play("spell"),o){h&&h.attackBuff(o,!0).catch(()=>{});const d=o.card.attack;return o.setAttack(d+t),{cardView:o,originalAttack:d,originalHealth:null}}return;case"spell_attack_debuff":if(o){h&&h.attackBuff(o,!1).catch(()=>{});const d=o.card.attack;return o.setAttack(Math.max(0,d-t)),{cardView:o,originalAttack:d,originalHealth:null}}return;case"spell_stat_buff":if(o){h&&h.attackBuff(o,!0).catch(()=>{});const d=o.card.attack,c=o.card.health,y=o._maxHealth;return o.setAttack(d+t),o._maxHealth=y+t,o.setHealth(c+t),{cardView:o,originalAttack:d,originalHealth:c,originalMaxHealth:y}}return;case"spell_stat_buff_perm":o&&(h&&h.attackBuff(o,!0).catch(()=>{}),o.setAttack(o.card.attack+t),o._maxHealth+=t,o.setHealth(o.card.health+t));return;case"spell_stat_debuff_perm":if(o){h&&h.attackBuff(o,!1).catch(()=>{});const d=Math.max(0,o.card.attack-t),c=Math.max(1,o.card.health-t),y=Math.max(1,o._maxHealth-t);o.setAttack(d),o._maxHealth=y,o.setHealth(c)}return;case"spell_damage_all_enemies":return He(t,i,h,u);case"draw_a_card":case"spell_draw_a_card":if(h&&n&&h.burstAt(...sa(n),8969727,10).catch(()=>{}),_.drawCard)for(let d=0;d<t;d++)_.drawCard();return;case"destroy_a_minion":case"spell_destroy_a_minion":M.play("destroy"),o&&await di(o,e,i,h);return;default:console.warn(`[Effects] Unknown effect id: "${a}"`)}}async function ia(a,t,e,i,s=null){switch(a){case"deathrattle_damage_all_enemies":return He(t,i,s,null);case"deathrattle_buff_random_friendly":{const n=e._placed.map(r=>r.cardView).filter(r=>!r.destroyed&&r.card.health>0);if(n.length===0)return;const l=n[Math.floor(Math.random()*n.length)];s&&await s.healSparkles(l),l.setAttack(l.card.attack+t),l._maxHealth+=t,l.setHealth(Math.min(l._maxHealth,l.card.health+t));return}default:console.warn(`[Effects] Unknown death effect id: "${a}"`)}}async function ci(a,t,e=null,i=null){const s=t._placed.map(r=>r.cardView).filter(r=>!r.destroyed&&r.card.health>0);if(s.length===0)return;const n=s[Math.floor(Math.random()*s.length)];e&&i?await e.projectile(i,n,16737792):Oe(n),await ka(n);const l=n.card.health-a;n.setHealth(l),n.card.health<=0&&await t.removeCardAnimated(n,e)}async function di(a,t,e,i=null){Oe(a);const s=t._placed.some(n=>n.cardView===a)?t:e;a.destroyed||await s.removeCardAnimated(a,i)}async function He(a,t,e=null,i=null){const s=t._placed.map(n=>n.cardView).filter(n=>!n.destroyed&&n.card.health>0);s.length!==0&&(e?await e.aoeBlast(s,16729088):await Promise.all(s.map(n=>(Oe(n),ka(n)))),await Promise.all(s.map(async n=>{n.destroyed||(n.setHealth(n.card.health-a),n.card.health<=0&&await t.removeCardAnimated(n,e))})))}async function fi(a,t,e=null){M.play("heal");const i=t._placed.map(l=>l.cardView).filter(l=>!l.destroyed&&l.card.health>0&&l.card.health<l._maxHealth);if(i.length===0)return;const s=i[Math.floor(Math.random()*i.length)];e?await e.healSparkles(s):ui(s);const n=Math.min(s._maxHealth,s.card.health+a);s.setHealth(n)}function Oe(a){if(!a._sprite)return;const t=a._sprite.tint;a._sprite.tint=16729156,setTimeout(()=>{a.destroyed||(a._sprite.tint=t)},260)}function ui(a){if(!a._sprite)return;const t=a._sprite.tint;a._sprite.tint=4521864,setTimeout(()=>{a.destroyed||(a._sprite.tint=t)},900)}function sa(a){const t=a.toGlobal({x:0,y:0});return[t.x,t.y]}async function ka(a){V(a);const t=a.x;for(const e of[12,-12,8,-8,4,-4,0])await S(a,{x:t+e},80);a.x=t}let B,E,J=[],Wt=[],tt=null,ot=-1,X=null,Et=null,Z=null,pe=[],Re=0,ae=0,Ut=0,qt=0,$t=0;const na=.62,_i=.011,pi=.1,gi=.62;function yi(){if(!tt)return;const a=Ut-qt;$t=$t*gi+a*pi,qt+=$t,tt.rotation=qt,Ut*=.92}function mi(a){Et=a}function xi(a){Z=a}function bi(a){Wt=a}let ie=null;function wi(a){ie=a}function Ci(){for(;pe.length>0&&!(Et!=null&&Et._animating);){const{card:a,hit:t,slotIndex:e}=pe.shift();if(!(a.destroyed||a._isOnField||X===a)&&E.cards.includes(a)){E.removeCard(a),a.parent&&a.parent.removeChild(a),t._pendingIndex=Math.min(e,t._placed.length),t.placeCard(a,null);break}}}function Ti(){pe.length=0}function vi(a,t,...e){B=a,E=t,J=e,a.stage.eventMode="dynamic",a.stage.hitArea={x:0,y:0,width:1e4,height:1e4,contains:()=>!0},a.stage.on("pointermove",Si),a.stage.on("pointerup",oa),a.stage.on("pointerupoutside",oa),a.ticker.add(yi)}function ft(a){a.eventMode="static",a.cursor="pointer",a._manaLabel&&(a._manaLabel.style.fill=16777215),a.off("pointerdown",la),a.on("pointerdown",la)}function la(a){var i;if(a.stopPropagation(),tt)return;const t=a.currentTarget;if(t._isOnField)return;if(V(t),V(t.scale),t.removeAllListeners("pointerover"),t.removeAllListeners("pointerout"),t.scale.set(1),X===t){X=null,t.rotation=0,ot=0,tt=t;return}if(t.y=t._baseY??t.y,t._manaLabel){const s=((i=t.card)==null?void 0:i.manaCost)??0,n=!Z||Z.rations>=s;t._manaLabel.style.fill=n?16639626:16729156}ot=E.cards.indexOf(t);const e=E.toGlobal({x:t.x,y:t.y});E.removeCard(t),B.stage.addChild(t),t.x=e.x,t.y=e.y,t.rotation=0,D.isDragging=!0,D.hide(),Re=e.x,e.y,ae=0,Ut=0,qt=0,$t=0,tt=t}function Si(a){var n;if(!tt)return;const t=a.global.x-Re;ae=ae*.45+t*.55,Ut=Math.max(-na,Math.min(na,ae*_i)),Re=a.global.x,a.global.y,tt.x=a.global.x,tt.y=a.global.y;const e=((n=tt.card)==null?void 0:n.type)==="spell",i=Wt.filter(l=>!J.includes(l));i.find(l=>e?l.isOverFieldIgnoreFull(a.global.x,a.global.y):l.isOverField(a.global.x,a.global.y))?(J.forEach(l=>{const r=l.toGlobal({x:0,y:0});l.updateHighlight(a.global.x,r.y)}),i.forEach(l=>l.clearHighlights())):J.forEach(l=>{e&&l.isOverFieldIgnoreFull(a.global.x,a.global.y)?l._lastPendingIndex=-1:l.updateHighlight(a.global.x,a.global.y)})}function oa(a){var r,o,h,u,_,d;if(!tt)return;const t=tt;tt=null,D.isDragging=!1,J.forEach(c=>c.clearHighlights()),Wt.filter(c=>!J.includes(c)).forEach(c=>c.clearHighlights()),Ut=0,qt=0,$t=0,t.rotation=0;const e=((r=t.card)==null?void 0:r.type)==="spell",s=Wt.filter(c=>!J.includes(c)).find(c=>e?c.isOverFieldIgnoreFull(a.global.x,a.global.y):c.isOverField(a.global.x,a.global.y));let n=null;if(s)if(e)n=J[0]??null;else{const c=J.find(y=>!y.isFull);if(c){const y=c.toGlobal({x:0,y:0});c.updateHighlight(a.global.x,y.y),n=c}}let l=n??J.find(c=>c.getSlotAt(a.global.x,a.global.y));if(!l&&e&&(l=J.find(c=>c.isOverFieldIgnoreFull(a.global.x,a.global.y))),l){const c=((o=t.card)==null?void 0:o.manaCost)??0;if(Z&&Z.rations<c){l.clearHighlights();const x=t.x,k=t.y;B.stage.removeChild(t),E.insertCard(t,ot),ft(t);const P=t.x,q=t.y,$=t.rotation,Y=E.toGlobal({x:P,y:q});t._laid=!1,E.removeCard(t),B.stage.addChild(t),t.x=x,t.y=k,t.rotation=0,t.scale.set(1),X=t,Z&&(Z.scale.set(1.2),setTimeout(()=>Z.scale.set(1),200)),S(t,{x:Y.x,y:Y.y,rotation:$},400).then(()=>{X===t&&(X=null,B.stage.removeChild(t),t.x=P,t.y=q,t.rotation=$,t._laid=!0,E.insertCard(t,ot),ft(t))});return}if(((h=t.card)==null?void 0:h.type)==="spell"){const x=(_=(u=t.card)==null?void 0:u.onPlayEffect)==null?void 0:_.id,k=x&&mt[x];if((k==null?void 0:k.requiresTarget)&&(k.targetAny?Wt:[l]).reduce((G,ct)=>G+ct._placed.length,0)===0){ki(t);return}l.clearHighlights(),Z&&Z.spend(c);const q=l.toGlobal({x:0,y:0});S(t,{x:q.x,y:q.y},220).then(()=>{t.alpha=1;const $=performance.now(),Y=()=>{const G=Math.min(1,(performance.now()-$)/350);t.scale.set(1+G*1.2),t.alpha=1-G,G<1?requestAnimationFrame(Y):(t.parent&&t.parent.removeChild(t),t.destroy({children:!0}))};requestAnimationFrame(Y),ie==null||ie(t)});return}const y=n?l.toGlobal({x:0,y:0}).y:a.global.y;l.updateHighlight(a.global.x,y);const T={x:a.global.x,y:a.global.y};if(Et!=null&&Et._animating){const x=l._pendingIndex??0;l.clearHighlights();const k=t.x,P=t.y;B.stage.removeChild(t),E.insertCard(t,ot),ft(t);const q=t.x,$=t.y,Y=t.rotation,G=E.toGlobal({x:q,y:$});t._laid=!1,E.removeCard(t),B.stage.addChild(t),t.x=k,t.y=P,t.rotation=0,t.scale.set(1),X=t,S(t,{x:G.x,y:G.y,rotation:Y},300).then(()=>{X===t&&(X=null,B.stage.removeChild(t),t.x=q,t.y=$,t.rotation=Y,t._laid=!0,E.insertCard(t,ot),ft(t))}),pe.push({card:t,hit:l,slotIndex:x})}else B.stage.removeChild(t),l.placeCard(t,T),Z&&Z.spend(((d=t.card)==null?void 0:d.manaCost)??0),J.forEach(x=>{x!==l&&x.clearHighlights()})}else{const c=t.x,y=t.y;B.stage.removeChild(t),E.insertCard(t,ot),ft(t);const T=t.x,x=t.y,k=t.rotation,P=E.toGlobal({x:T,y:x});t._laid=!1,E.removeCard(t),B.stage.addChild(t),t.x=c,t.y=y,t.rotation=0,t.scale.set(1),X=t,S(t,{x:P.x,y:P.y,rotation:k},400).then(()=>{X===t&&(X=null,B.stage.removeChild(t),t.x=T,t.y=x,t.rotation=k,t._laid=!0,E.insertCard(t,ot),ft(t))})}}function ki(a,t){const e=a.x,i=a.y;B.stage.removeChild(a),E.insertCard(a,ot),ft(a);const s=a.x,n=a.y,l=a.rotation,r=E.toGlobal({x:s,y:n});a._laid=!1,E.removeCard(a),B.stage.addChild(a),a.x=e,a.y=i,a.rotation=0,a.scale.set(1),X=a,S(a,{x:r.x,y:r.y,rotation:l},400).then(()=>{X===a&&(X=null,B.stage.removeChild(a),a.x=s,a.y=n,a.rotation=l,a._laid=!0,E.insertCard(a,ot),ft(a))})}const Ai=new URL(""+new URL("AttackArrow-26ec5dd2.png",import.meta.url).href,self.location).href,Ae=200;class Li extends z{constructor(){super(),this.visible=!1,this.zIndex=1e3;const t=rt.from(Ai);this._sprite=new Lt(t),this._sprite.anchor.set(0,.5),this._sprite.height=Ae,this.addChild(this._sprite),t.baseTexture.valid||t.baseTexture.once("loaded",()=>{this._sprite.height=Ae})}update(t,e,i,s){const n=i-t,l=s-e,r=Math.sqrt(n*n+l*l);r<10||(this.visible=!0,this.x=t,this.y=e,this.rotation=Math.atan2(l,n),this._sprite.width=r,this._sprite.height=Ae)}hide(){this.visible=!1}}function Fi(a){return 1-(1-a)*(1-a)}function Ei(a){return a*a}class Pi{constructor(t,e,i){this._app=t,this._playerField=e,this._opponentField=i,this._targeting=!1,this._animating=!1,this._attacker=null,this._exhausted=new Set,this._isPlayerTurn=!0,this._queue=[],this._arrow=new Li,t.stage.addChild(this._arrow),t.stage.sortableChildren=!0,this._attackerField=null,this._targetField=null,t.stage.on("pointermove",s=>this._onMove(s)),t.stage.on("pointerup",s=>this._onUp(s)),t.stage.on("pointerupoutside",s=>this._onUp(s)),t.ticker.addOnce(()=>this._applyTurnTint()),this._vfx=null}setVFX(t){this._vfx=t}armCard(t,e=!1){t.removeAllListeners("pointerdown"),t.removeAllListeners("pointerover"),t.removeAllListeners("pointerout"),t.eventMode="static",t._isOnField=!0,t._previewSnap||(t._previewSnap={...t.card}),D.preload(t),t.on("pointerdown",i=>this._onAttackerDown(i,t,this._playerField,this._opponentField)),t.on("pointerover",()=>{!D.isDragging&&!this._targeting&&D.show(t)}),t.on("pointerout",()=>D.hide()),e?(this._exhausted.add(t),t._sprite.tint=8947848,t.cursor="default"):(t._sprite.tint=this._isPlayerTurn?16777215:8947848,t.cursor=this._isPlayerTurn?"crosshair":"default")}armOpponentCard(t,e=!1){t.removeAllListeners("pointerdown"),t.removeAllListeners("pointerover"),t.removeAllListeners("pointerout"),t.eventMode="static",t._isOnField=!0,t._previewSnap||(t._previewSnap={...t.card}),D.preload(t),t.on("pointerdown",i=>this._onAttackerDown(i,t,this._opponentField,this._playerField)),t.on("pointerover",()=>{!D.isDragging&&!this._targeting&&D.show(t)}),t.on("pointerout",()=>D.hide()),e?(this._exhausted.add(t),t._sprite.tint=8947848,t.cursor="default"):(t._sprite.tint=this._isPlayerTurn?8947848:16777215,t.cursor=this._isPlayerTurn?"default":"crosshair")}_onAttackerDown(t,e,i,s){t.stopPropagation(),!(this._targeting||this._exhausted.has(e)||e.card.attack<=0||i===this._playerField!==this._isPlayerTurn)&&(D.hide(),V(e),V(e.scale),e.y=0,e.scale.set(1),this._targeting=!0,this._attacker=e,this._attackerField=i,this._targetField=s,e.setHighlight(!0))}_onMove(t){if(!this._targeting||!this._attacker)return;const e=this._cardGlobalCenter(this._attacker);this._arrow.update(e.x,e.y,t.global.x,t.global.y);for(const{cardView:i}of this._targetField._placed){const n=this._pointerOverCard(t.global,i)?N.typeMultiplier(this._attacker.card.faction,i.card.faction):null;i._lastTargetMult!==n&&(i._lastTargetMult=n,i.setTargetGlow(n),n===null&&(i._sprite.tint=8947848))}}_onUp(t){if(!this._targeting)return;this._arrow.hide(),this._attacker.setHighlight(!1);for(const{cardView:i}of this._targetField._placed)i._lastTargetMult=void 0,i.setTargetGlow(null),i._sprite.tint=8947848;const e=this._targetField._placed.map(i=>i.cardView).find(i=>this._pointerOverCard(t.global,i));e&&this._enqueue(this._attacker,e,this._attackerField,this._targetField),this._targeting=!1,this._attacker=null,this._attackerField=null,this._targetField=null}_cardGlobalCenter(t){return t.parent.toGlobal({x:t.x,y:t.y})}_pointerOverCard(t,e){const i=e.parent.toLocal(t),s=65,n=91;return i.x>=e.x-s&&i.x<=e.x+s&&i.y>=e.y-n&&i.y<=e.y+n}async _playAttackAnimation(t,e,i,s){this._animating=!0,V(t),V(t.scale),t.eventMode="none",t.y=0,t.scale.set(1);const n={x:t.x,y:0},l=this._app.stage,r=i.toGlobal({x:t.x,y:t.y});i.removeChild(t),l.addChild(t),t.x=r.x,t.y=r.y,t.zIndex=999;try{const _=s.toGlobal({x:e.x,y:e.y}),d=r.x,c=r.y,y=d+(_.x-d)*.7,T=c+(_.y-c)*.7;await S(t,{x:y,y:T},420,Ei);const x=(y+_.x)*.5,k=(T+_.y)*.5,P=Math.atan2(_.y-c,_.x-d);this._vfx&&this._vfx.clashAt(x,k,P).catch(()=>{}),M.play("hit"),this._shakeCard(e),await this._wait(200);const q=t.card.attack,$=e.card.attack,Y=N.typeMultiplier(t.card.faction,e.card.faction),G=Math.max(1,q+Y),ct=Math.max(0,$);if(e.setHealth(e.card.health-G),t.setHealth(t.card.health-ct),this._vfx){const L=s.toGlobal({x:e.x,y:e.y}),dt=i.toGlobal({x:t.x,y:t.y});this._vfx.floatNumber(L.x,L.y,`-${G}`,16729156).catch(()=>{}),this._vfx.floatNumber(dt.x,dt.y,`-${ct}`,16746632).catch(()=>{})}await S(t,{x:d,y:c},600,Fi)}finally{t.parent===l&&l.removeChild(t),t.destroyed||(i.addChild(t),t.x=n.x,t.y=0,t.zIndex=0,t.eventMode="static",t._setGlow(!1)),e.destroyed||(e._setGlow(!1),e.y=0),this._animating=!1}const o=e.card.health<=0,h=t.card.health<=0,u=o||h;if(o&&await s.removeCardAnimated(e,this._vfx),h){this._exhausted.delete(t),await i.removeCardAnimated(t,this._vfx),this._applyTurnTint(),setTimeout(()=>this._processQueue(),320);return}this._exhausted.add(t),t._sprite.tint=7829367,t.cursor="default",this._applyTurnTint(),u?setTimeout(()=>this._processQueue(),320):this._processQueue()}endTurn(){this._isPlayerTurn=!this._isPlayerTurn,this._queue.length=0,Ti();for(const t of this._exhausted)t._sprite.tint=16777215,t.cursor="crosshair";this._exhausted.clear(),this._applyTurnTint()}_applyTurnTint(){for(const{cardView:i}of this._playerField._placed)this._exhausted.has(i)||(i._sprite.tint=this._isPlayerTurn?16777215:8947848,i.cursor=this._isPlayerTurn?"crosshair":"default");for(const{cardView:i}of this._opponentField._placed)this._exhausted.has(i)||(i._sprite.tint=this._isPlayerTurn?8947848:16777215,i.cursor=this._isPlayerTurn?"default":"crosshair")}_enqueue(t,e,i,s){this._queue.push({attacker:t,target:e,attackerField:i,targetField:s}),this._processQueue()}aiAttack(t,e){this._isPlayerTurn||this._exhausted.has(t)||this._opponentField._placed.find(i=>i.cardView===t)&&this._playerField._placed.find(i=>i.cardView===e)&&this._enqueue(t,e,this._opponentField,this._playerField)}_processQueue(){if(this._animating||(Ci(),this._queue.length===0))return;for(;this._queue.length>0;){const n=this._queue[0],{attacker:l,target:r,attackerField:o,targetField:h}=n,u=!l.destroyed&&o._placed.some(y=>y.cardView===l),_=!r.destroyed&&h._placed.some(y=>y.cardView===r),d=!this._exhausted.has(l),c=o===this._playerField===this._isPlayerTurn;if(u&&_&&d&&c)break;this._queue.shift()}if(this._queue.length===0)return;const{attacker:t,target:e,attackerField:i,targetField:s}=this._queue.shift();this._playAttackAnimation(t,e,i,s)}async _shakeCard(t){V(t);const e=t.x;for(const i of[14,-14,9,-9,5,-5,0])await S(t,{x:e+i},90);t.x=e}_wait(t){return new Promise(e=>setTimeout(e,t))}}const Mi=900,Ii=600,Hi=500;let At=null,w=null,C=null,pt=null,gt=null,ra=null,ha=null,ca=null,Le=null,da=null;const fa={init({hand:a,field:t,playerField:e,combat:i,rations:s,vfx:n,opponentMorale:l,playerMorale:r,registerBuff:o,drawCard:h}){At=a,w=t,C=e,pt=i,gt=s??null,ra=n??null,ha=l??null,ca=r??null,Le=o??null,da=h??null},onOpponentTurnStart(){console.log("%c[AI] ── Opponent turn start ──","color:#a78bfa;font-weight:bold"),setTimeout(()=>this._act(),Mi)},_act(){this._playCard().then(()=>{setTimeout(()=>{this._attack(),this._waitForQueueThenEndTurn()},Ii)})},_waitForQueueThenEndTurn(){const a=()=>{if(pt._animating||pt._queue.length>0){setTimeout(a,100);return}pt._isPlayerTurn||pt.endTurn()};setTimeout(a,150)},_scoreCardPlay(a){const t=a.card;let e=t.attack+t.health;for(const{cardView:n}of(C==null?void 0:C._placed)??[])N.typeMultiplier(t.faction,n.card.faction)===1&&(e+=2);const i=t.onPlayEffect;i!=null&&i.id&&(e+=this._scoreOnPlayEffect(i));const s=t.deathEffect;return s!=null&&s.id&&(e+=this._scoreDeathEffect(s)),e},_scoreOnPlayEffect(a){switch(a.id){case"deal_damage_random_enemy":{const t=((C==null?void 0:C._placed)??[]).map(i=>i.cardView).filter(i=>i.card.health>0);if(t.length===0)return 0;const e=t.filter(i=>i.card.health<=a.value).length;return a.value+e*3}case"deal_damage_all_enemies":{const t=((C==null?void 0:C._placed)??[]).map(i=>i.cardView).filter(i=>i.card.health>0);if(t.length===0)return 0;const e=t.filter(i=>i.card.health<=a.value).length;return a.value*t.length+e*3}case"spell_damage_all_enemies":{const t=((C==null?void 0:C._placed)??[]).map(i=>i.cardView).filter(i=>i.card.health>0);if(t.length===0)return 0;const e=t.filter(i=>i.card.health<=a.value).length;return a.value*t.length+e*3}case"draw_a_card":case"spell_draw_a_card":return a.value*4;case"destroy_a_minion":case"spell_destroy_a_minion":return((C==null?void 0:C._placed)??[]).length>0?10:0;case"heal_random_friendly":return((w==null?void 0:w._placed)??[]).map(e=>e.cardView).filter(e=>e.card.health>0&&e.card.health<e._maxHealth).length===0?0:Math.ceil(a.value/2);case"gain_morale":return Math.ceil(a.value/2);case"drain_morale":return a.value;case"gain_ration_this_turn":return a.value;case"spell_gain_morale":return Math.ceil(a.value/2);case"spell_drain_morale":return a.value;case"spell_attack_buff":return((w==null?void 0:w._placed)??[]).map(e=>e.cardView).filter(e=>e.card.health>0).length>0?a.value*2:0;case"spell_attack_debuff":return((C==null?void 0:C._placed)??[]).map(e=>e.cardView).filter(e=>e.card.health>0).length>0?a.value*2:0;case"spell_stat_buff":return((w==null?void 0:w._placed)??[]).length>0?a.value*2:0;case"spell_stat_buff_perm":return((w==null?void 0:w._placed)??[]).length>0?a.value*3:0;case"spell_stat_debuff_perm":return((C==null?void 0:C._placed)??[]).length>0?a.value*3:0;default:return 0}},_scoreDeathEffect(a){switch(a.id){case"deathrattle_damage_all_enemies":{const t=((C==null?void 0:C._placed)??[]).length;return a.value*Math.max(1,t)}case"deathrattle_buff_random_friendly":return((w==null?void 0:w._placed)??[]).length>0?a.value*2:a.value;default:return 0}},_playCard(){var r,o,h,u,_,d;if(!At||!w)return Promise.resolve();const a=[],t=5-w._placed.length;let i=gt?gt.rations:1/0,s=0;const n=At.cards.slice().sort((c,y)=>this._scoreCardPlay(y)-this._scoreCardPlay(c));for(const c of n){const y=((r=c.card)==null?void 0:r.type)==="spell";if(!y&&s>=t)continue;if(y){const x=(h=(o=c.card)==null?void 0:o.onPlayEffect)==null?void 0:h.id;if(x&&((u=mt[x])==null?void 0:u.requiresTarget)&&w._placed.length===0&&s===0)continue}const T=((_=c.card)==null?void 0:_.manaCost)??0;T>i||(a.push(c),i-=T,y||s++)}if(a.length===0)return Promise.resolve();console.log(`%c[AI] Playing ${a.length} card(s) from hand:`,"color:#34d399"),a.forEach((c,y)=>{const T=this._scoreCardPlay(c),x=c.card.onPlayEffect,k=x!=null&&x.id?`  effect:${x.id}(${x.value}) +${this._scoreOnPlayEffect(x)}`:"";console.log(`  ${y+1}. "${c.card.name||c.card.id}" [${c.card.faction}] ATK:${c.card.attack} HP:${c.card.health}  play-score=${T}${k}`)});let l=Promise.resolve();for(const c of a){const y=((d=c.card)==null?void 0:d.type)==="spell"?()=>this._castSpell(c):()=>this._animatePlace(c);l=l.then(y)}return l},_castSpell(a){return new Promise(t=>{var l;const e=w.parent;At.removeCard(a),gt&&gt.spend(((l=a.card)==null?void 0:l.manaCost)??0);const i=At.toGlobal({x:0,y:0}),s=w.toGlobal({x:0,y:0});e.addChild(a),a.x=i.x,a.y=i.y,a.scale.set(1),a.rotation=0;const n=a.card.onPlayEffect;S(a,{x:s.x,y:s.y},400).then(()=>S(a.scale,{x:0},120)).then(()=>(a.useFrontFace(),S(a.scale,{x:1},140))).then(()=>S(a,{x:s.x,y:s.y-30},180)).then(()=>new Promise(r=>setTimeout(r,1e3))).then(async()=>{if(n!=null&&n.id){let h=null;if(n.id==="spell_attack_buff"||n.id==="spell_stat_buff"||n.id==="spell_stat_buff_perm"){const _=w._placed.map(d=>d.cardView).filter(d=>!d.destroyed&&d.card.health>0);_.length>0&&(h=_.reduce((d,c)=>c.card.attack>d.card.attack?c:d))}else if(n.id==="spell_attack_debuff"||n.id==="spell_stat_debuff_perm"){const _=C._placed.map(d=>d.cardView).filter(d=>!d.destroyed&&d.card.health>0);_.length>0&&(h=_.reduce((d,c)=>c.card.attack>d.card.attack?c:d))}else if(n.id==="destroy_a_minion"||n.id==="spell_destroy_a_minion"){const _=C._placed.map(d=>d.cardView).filter(d=>!d.destroyed&&d.card.health>0);_.length>0&&(h=_.reduce((d,c)=>c.card.attack>d.card.attack?c:d))}const u=await Dt(n.id,n.value??1,w,C,pt,ha,ca,gt,h,ra,a,{drawCard:da});u!=null&&u.cardView&&Le&&Le(u)}const r=performance.now(),o=()=>{const h=Math.min(1,(performance.now()-r)/320);a.scale.set(1+h*1.2),a.alpha=1-h,h<1?requestAnimationFrame(o):(a.parent&&a.parent.removeChild(a),a.destroy({children:!0}),t())};requestAnimationFrame(o)})})},_animatePlace(a){return new Promise(t=>{if(w.isFull){t();return}const e=w.parent;At.removeCard(a);const i=At.toGlobal({x:0,y:0}),s=w.toGlobal({x:0,y:-110});e.addChild(a),a.x=i.x,a.y=i.y,a.scale.set(1),a.rotation=0,S(a,{x:s.x,y:s.y},500).then(()=>(a.useFieldFrame(),new Promise(n=>setTimeout(n,Hi)))).then(async()=>{var n;w.isFull||(w._pendingIndex=w._placed.length,gt&&gt.spend(((n=a.card)==null?void 0:n.manaCost)??0),await w.placeCard(a,null).catch(()=>{})),t()})})},_scoreMatchup(a,t,e){var y,T;const i=a.card,s=t.card,n=N.typeMultiplier(i.faction,s.faction),l=N.typeMultiplier(s.faction,i.faction),r=Math.max(1,i.attack+n),o=Math.max(0,s.attack),u=e-r<=0,_=i.health-o<=0,d=r-o;let c=0;if(u&&(c+=5),u&&s.attack>=4&&(c+=3),n===1&&(c+=2),l===-1&&(c+=1),_&&!u&&(c-=4),_&&u&&(c-=2),c+=d/20,u&&((y=s.deathEffect)==null?void 0:y.id)==="deathrattle_damage_all_enemies"){const x=(w==null?void 0:w._placed.length)??0;c-=s.deathEffect.value*x}return u&&((T=s.deathEffect)==null?void 0:T.id)==="deathrattle_buff_random_friendly"&&((C==null?void 0:C._placed.length)??1)-1>0&&(c-=s.deathEffect.value),c},_attack(){if(!w||!C)return;const a=w._placed.map(s=>s.cardView).filter(s=>!pt._exhausted.has(s)&&s.card.attack>0);if(a.length===0){console.log("%c[AI] No available attackers.","color:#94a3b8");return}const t=C._placed.map(s=>s.cardView);if(t.length===0){console.log("%c[AI] No targets on player field.","color:#94a3b8");return}console.log(`%c[AI] Evaluating attacks — ${a.length} attacker(s), ${t.length} target(s)`,"color:#a78bfa");const e=new Map;for(const{cardView:s}of C._placed)e.set(s,s.card.health);const i=a.map(s=>{const{best:n}=this._pickBestTarget(s,e);return{attacker:s,bestScore:(n==null?void 0:n.score)??-1/0}}).sort((s,n)=>n.bestScore-s.bestScore);for(const{attacker:s}of i){if([...e.entries()].filter(([,P])=>P>0).map(([P])=>P).length===0)break;const l=new Map([...e].filter(([,P])=>P>0)),{best:r}=this._pickBestTarget(s,l);if(!r)continue;if(r.score<=-3){console.log(`%c[AI] SKIP  "${s.card.name||s.card.id}" — best score ${r.score.toFixed(2)} is a losing trade`,"color:#f87171");continue}const o=s.card,h=r.target.card,u=N.typeMultiplier(o.faction,h.faction),_=N.typeMultiplier(h.faction,o.faction),d=Math.max(1,o.attack+u),c=Math.max(1,h.attack+_),y=e.get(r.target)-d<=0,T=o.health-c<=0,x=u===1?"✅ advantage":u===-1?"❌ disadvantage":"➖ neutral",k=y&&!T?"WIN TRADE":y&&T?"EVEN TRADE":!y&&T?"LOSING TRADE":"CHIP";console.log(`%c[AI] ATTACK "${o.name||o.id}" [${o.faction}] → "${h.name||h.id}" [${h.faction}]  dmg:${d}  ret:${c}  score:${r.score.toFixed(2)}  ${x}  ${k}`,"color:#fbbf24"),pt.aiAttack(s,r.target),e.set(r.target,(e.get(r.target)??0)-d)}},_pickBestTarget(a,t){let e=-1/0,i=[];for(const[n,l]of t){if(l<=0)continue;const r=this._scoreMatchup(a,n,l);r>e?(e=r,i=[n]):r===e&&i.push(n)}return i.length===0?{best:null}:{best:{target:i[Math.floor(Math.random()*i.length)],score:e}}}};let Fe=!1;function ua(a,t,e){return Fe||a.length===0?Promise.resolve(null):(Fe=!0,new Promise(i=>{const s=n=>{Fe=!1;for(const l of a)l.setTargetGlow(null),l.off("pointerdown",l._targetHandler),delete l._targetHandler;i(n)};for(const n of a){n.setTargetGlow(t?1:-1,e);const l=()=>s(n);n._targetHandler=l,n.on("pointerdown",l)}}))}const Ri=40;class _a extends z{constructor(t){super(),this._morale=Ri,this._isPlayer=t,this.onDepleted=null,this.onTakeDamage=null,this._build()}_build(){this._bg=new H,this.addChild(this._bg);const t=new O({fontFamily:"serif",fontSize:22,fill:14737648});this._icon=new R("♥",t),this._icon.anchor.set(.5),this._icon.x=-28,this._icon.y=0,this.addChild(this._icon),this._style=new O({fontFamily:"Georgia, serif",fontSize:28,fontWeight:"bold",fill:[16777215,16764108],fillGradientType:Kt.LINEAR_VERTICAL,dropShadow:!0,dropShadowColor:0,dropShadowDistance:2,dropShadowBlur:4}),this._label=new R(String(this._morale),this._style),this._label.anchor.set(.5),this._label.x=10,this._label.y=0,this.addChild(this._label),this._drawBg(!1)}_drawBg(t){const e=this._bg;e.clear();const i=t?8330525:1973808,s=.82;e.beginFill(i,s),e.drawRoundedRect(-52,-22,104,44,14),e.endFill(),e.lineStyle(1.5,t?16737894:5588070,.9),e.drawRoundedRect(-52,-22,104,44,14)}get morale(){return this._morale}takeDamage(){var t,e;this._morale=Math.max(0,this._morale-1),this._label.text=String(this._morale),this._icon.style.fill=this._morale<=10?16729156:14737648,this._flashAndBounce(!0),(t=this.onTakeDamage)==null||t.call(this),this._morale===0&&((e=this.onDepleted)==null||e.call(this))}gainMorale(t){this._morale+=t,this._label.text=String(this._morale),this._flashAndBounce(!1)}_flashAndBounce(t){if(this._drawBg(t),!t){const h=this._bg;h.clear(),h.beginFill(1332013,.85),h.drawRoundedRect(-52,-22,104,44,14),h.endFill(),h.lineStyle(1.5,4906624,.9),h.drawRoundedRect(-52,-22,104,44,14)}let e=0;const i=500,s=Yt.shared,n=h=>{e+=h/60*1e3,e>=i&&(this._drawBg(!1),s.remove(n))};s.add(n),this.scale.set(1.25);const l=performance.now(),r=300,o=()=>{const h=Math.min(1,(performance.now()-l)/r),u=1.25-.25*h;this.scale.set(u),h<1&&requestAnimationFrame(o)};requestAnimationFrame(o)}}const Di=10;class pa extends z{constructor(){super(),this._maxThisTurn=1,this._rations=1,this._build()}_build(){this._bg=new H,this.addChild(this._bg);const t=new O({fontFamily:"serif",fontSize:18,fill:16498468});this._icon=new R("⚡",t),this._icon.anchor.set(.5),this._icon.x=-28,this._icon.y=0,this.addChild(this._icon),this._style=new O({fontFamily:"Georgia, serif",fontSize:18,fontWeight:"bold",fill:[16639626,16096779],fillGradientType:Kt.LINEAR_VERTICAL,dropShadow:!0,dropShadowColor:0,dropShadowDistance:2,dropShadowBlur:3}),this._label=new R(this._text(),this._style),this._label.anchor.set(.5),this._label.x=10,this._label.y=0,this.addChild(this._label),this._drawBg(!1)}_text(){return`${this._rations} / ${this._maxThisTurn}`}_drawBg(t){const e=this._bg;e.clear(),e.beginFill(t?7877903:1841680,.82),e.drawRoundedRect(-52,-16,104,32,10),e.endFill(),e.lineStyle(1.2,t?16569165:9584654,.9),e.drawRoundedRect(-52,-16,104,32,10)}get rations(){return this._rations}nextTurn(){this._maxThisTurn<Di&&this._maxThisTurn++,this._rations=this._maxThisTurn,this._label.text=this._text(),this._flash()}spend(t){this._rations=Math.max(0,this._rations-t),this._label.text=this._text()}gainThisTurn(t){this._rations+=t,this._label.text=this._text(),this._flash()}_flash(){this._drawBg(!0);let t=0;const e=Yt.shared,i=l=>{t+=l/60*1e3,t>=500&&(this._drawBg(!1),e.remove(i))};e.add(i),this.scale.set(1.18);const s=performance.now(),n=()=>{const l=Math.min(1,(performance.now()-s)/280);this.scale.set(1.18-.18*l),l<1&&requestAnimationFrame(n)};requestAnimationFrame(n)}}function Oi(a){const{stage:t,screen:e}=a,i=new aa;i.x=e.width/2,i.y=e.height*.37,t.addChild(i);const s=new aa;s.x=e.width/2,s.y=e.height*.63,t.addChild(s);const n=new Ze;n.isOpponent=!0,n.x=e.width*.3,n.y=e.height*.13,n.scale.y=-1,n.slotKey="hand-slot-positions-opponent",t.addChild(n);const l=new Ze;l.x=e.width*.3,l.y=e.height*.88,t.addChild(l);const r=new ta(!0);r.x=a.screen.width-85,r.y=a.screen.height-90,t.addChild(r);const o=new ta(!1);o.x=a.screen.width-85,o.y=90,t.addChild(o);let h=N.loadFromStorage(),u=N.loadFromStorage();r.setCount(h.length),o.setCount(u.length),vi(a,l,s),bi([s,i]),D.init(a);const _=new Pi(a,s,i);mi(_);const d=new Na(a);t.addChild(d.container),_.setVFX(d),s.setVFX(d),i.setVFX(d);const c=new _a(!1);c.x=e.width/2,c.y=66,t.addChild(c);const y=new _a(!0);y.x=e.width/2,y.y=e.height-22,t.addChild(y);const T=new pa;T.x=e.width/2,T.y=22,t.addChild(T);const x=new pa;x.x=e.width/2,x.y=e.height-66,t.addChild(x),xi(x);const k=new Map,P={drawCard:()=>{G(h,l),r.setCount(h.length)}};wi(async f=>{await d.battlecryBurst(f).catch(()=>{});const g=f.card.onPlayEffect;if(!(g!=null&&g.id))return;const p=mt[g.id];if(p!=null&&p.requiresTarget){const v=p.targetAny?[...s._placed.map(j=>j.cardView),...i._placed.map(j=>j.cardView)]:(p.targetFriendly?s:i)._placed.map(j=>j.cardView);if(v.length===0)return;const m=p.isPositive??!!p.targetFriendly,A=p.targetLabel??(m?`+${g.value??1}`:`-${g.value??1}`),b=await ua(v,m,A);if(!b)return;const F=await Dt(g.id,g.value??1,s,i,_,y,c,x,b,d,null,P);F!=null&&F.cardView&&!k.has(F.cardView)&&k.set(F.cardView,{attack:F.originalAttack,health:F.originalHealth??null,maxHealth:F.originalMaxHealth??null})}else Dt(g.id,g.value??1,s,i,_,y,c,x,null,d,null,P)});function q(f,g,p,v){if(!(f!=null&&f.id))return!1;const m=mt[f.id];return m?m.requiresTarget?(m.targetAny?[...p._placed.map(b=>b.cardView),...v._placed.map(b=>b.cardView)]:(m.targetFriendly?p:v)._placed.map(b=>b.cardView)).filter(b=>b!==g).length>0:f.id==="deal_damage_random_enemy"||f.id==="deal_damage_all_enemies"?v._placed.some(A=>!A.cardView.destroyed&&A.cardView.card.health>0):f.id==="heal_random_friendly"?p._placed.some(A=>A.cardView!==g&&!A.cardView.destroyed&&A.cardView.card.health>0&&A.cardView.card.health<A.cardView._maxHealth):!0:!1}s.onCardRemoved=()=>y.takeDamage(),i.onCardRemoved=()=>c.takeDamage(),s.onCardKilled=f=>{var p;const g=(p=f.card)==null?void 0:p.deathEffect;g!=null&&g.id&&ia(g.id,g.value??1,s,i,d)},i.onCardKilled=f=>{var p;const g=(p=f.card)==null?void 0:p.deathEffect;g!=null&&g.id&&ia(g.id,g.value??1,i,s,d)},s.onCardLanded=f=>{var v,m;f.useFieldFrame(),_.armCard(f,!0);const g=((v=f.card)==null?void 0:v.faction)??null,p=(m=f.card)==null?void 0:m.summonVfxPreset;p?d.playPreset(p,f).catch(()=>{}):d.hasFactionPreset(g)?d.playFactionPreset(g,f).catch(()=>{}):d.summonFlash(f,g).catch(()=>{})},s.onCardPlaced=async f=>{var v;const g=((v=f.card)==null?void 0:v.faction)??null,p=f.card.onPlayEffect;await Ue.runCardPlay({summon_vfx:async()=>{},battlecry_burst:async()=>{if(q(p,f,s,i)){const m=mt[p.id];m!=null&&m.requiresTarget?(d.battlecryBurst(f,g).catch(()=>{}),await new Promise(A=>setTimeout(A,180))):await d.battlecryBurst(f,g).catch(()=>{})}},on_play:async()=>{if(!(p!=null&&p.id))return;const m=mt[p.id];if(m!=null&&m.requiresTarget){const A=(m.targetAny?[...s._placed.map(b=>b.cardView),...i._placed.map(b=>b.cardView)]:(m.targetFriendly?s:i)._placed.map(b=>b.cardView)).filter(b=>b!==f);if(A.length>0){const b=m.isPositive??!!m.targetFriendly,F=m.targetLabel??(b?`+${p.value??1}`:`-${p.value??1}`),j=await ua(A,b,F);j&&await Dt(p.id,p.value??1,s,i,_,y,c,x,j,d,f,P)}}else await Dt(p.id,p.value??1,s,i,_,y,c,x,null,d,f,P)}})},i.onCardLanded=f=>{var v,m;_.armOpponentCard(f,!0);const g=((v=f.card)==null?void 0:v.faction)??null,p=(m=f.card)==null?void 0:m.summonVfxPreset;p?d.playPreset(p,f).catch(()=>{}):d.hasFactionPreset(g)?d.playFactionPreset(g,f).catch(()=>{}):d.summonFlash(f,g).catch(()=>{})},i.onCardPlaced=async f=>{var v;const g=((v=f.card)==null?void 0:v.faction)??null,p=f.card.onPlayEffect;await Ue.runCardPlay({summon_vfx:async()=>{},battlecry_burst:async()=>{if(q(p,f,i,s)){const m=mt[p.id];m!=null&&m.requiresTarget?(d.battlecryBurst(f,g).catch(()=>{}),await new Promise(A=>setTimeout(A,180))):await d.battlecryBurst(f,g).catch(()=>{})}},on_play:async()=>{if(!(p!=null&&p.id))return;const m=mt[p.id];let A=null;if(m!=null&&m.requiresTarget){const b=(m.targetAny?[...i._placed.map(F=>F.cardView),...s._placed.map(F=>F.cardView)]:(m.targetFriendly?i:s)._placed.map(F=>F.cardView)).filter(F=>F!==f);b.length>0&&(A=b[Math.floor(Math.random()*b.length)])}(!(m!=null&&m.requiresTarget)||A)&&await Dt(p.id,p.value??1,i,s,_,c,y,T,A,d,f,{drawCard:()=>{ct(u),o.setCount(u.length)}})}})};function $(f,g,p){const v=f.x,m=f.y,A=g.toGlobal({x:0,y:0}),b=p.toLocal(A);f.x=b.x,f.y=b.y,f.scale.set(.3),f.alpha=0,f._isFlying=!0,M.play("draw"),Promise.all([S(f,{x:v,y:m,alpha:1},700),xa(f.scale,{x:1,y:1},700)]).then(()=>{f._isFlying=!1})}const Y=8;function G(f,g){if(f.length===0)return;const p=f.shift();if(g.cards.length>=Y)return;const v=new Ft(p);g.addCard(v),ft(v),$(v,r,g)}for(let f=0;f<4;++f)G(h,l);r.setCount(h.length);function ct(f){if(f.length===0)return;const g=f.shift();if(n.cards.length>=Y)return;const p=new Ft(g);p.useBackFace(),n.addCard(p),$(p,o,n)}for(let f=0;f<4;++f)ct(u);o.setCount(u.length),fa.init({hand:n,field:i,playerField:s,combat:_,rations:T,vfx:d,opponentMorale:c,playerMorale:y,registerBuff:f=>{f!=null&&f.cardView&&!k.has(f.cardView)&&k.set(f.cardView,{attack:f.originalAttack,health:f.originalHealth??null,maxHealth:f.originalMaxHealth??null})},drawCard:()=>{ct(u),o.setCount(u.length)}});const L=new H,dt=130,Bt=44;function ye(f){L.clear(),L.beginFill(f?15770880:12877568,1),L.drawRoundedRect(0,0,dt,Bt,10),L.endFill()}ye(!1),L.eventMode="static",L.cursor="pointer";const Zt=new R("End Turn",new O({fontSize:18,fill:16777215,fontWeight:"bold"}));Zt.anchor.set(.5),Zt.x=dt/2,Zt.y=Bt/2,L.addChild(Zt),L.on("pointerover",()=>ye(!0)),L.on("pointerout",()=>ye(!1)),L.on("pointerdown",()=>{L._endTurnPending||(L._endTurnPending=!0,L.interactive=!1,L.alpha=.5,M.play("endTurn"),setTimeout(()=>{L._endTurnPending=!1,L.interactive=!0,L.alpha=1,_.endTurn()},1e3))});const U=new H;function me(f){U.clear(),U.beginFill(f?5933626:4025124,1),U.drawRoundedRect(0,0,dt,Bt,10),U.endFill()}me(!1),U.eventMode="static",U.cursor="pointer";const Jt=new R("Restart",new O({fontSize:18,fill:16777215,fontWeight:"bold"}));Jt.anchor.set(.5),Jt.x=dt/2,Jt.y=Bt/2,U.addChild(Jt),U.on("pointerover",()=>me(!0)),U.on("pointerout",()=>me(!1)),U.on("pointerdown",()=>window.location.reload());function Xe(){L.x=a.screen.width-dt-20,L.y=a.screen.height/2-Bt-6,U.x=a.screen.width-dt-20,U.y=a.screen.height/2+6,r.x=a.screen.width-85,r.y=a.screen.height-90,o.x=a.screen.width-85,o.y=90}Xe(),t.addChild(L),t.addChild(U);function Ne(f){_._isPlayerTurn=!1;const g=a.screen.width,p=a.screen.height,v=new H;v.beginFill(0,.72),v.drawRect(0,0,g,p),v.endFill(),v.eventMode="static",v.hitArea={contains:()=>!0},t.addChild(v);const m=420,A=240,b=new H;b.beginFill(f?1718810:3807770,.97),b.drawRoundedRect(0,0,m,A,22),b.endFill(),b.lineStyle(3,f?7266400:16733525,1),b.drawRoundedRect(0,0,m,A,22),b.x=(g-m)/2,b.y=(p-A)/2,t.addChild(b);const F=new R(f?"⚔️  Victory!":"💀  Defeat",new O({fontFamily:"Georgia, serif",fontSize:52,fontWeight:"bold",fill:f?[11206570,4513092]:[16751001,16724787],fillGradientType:Kt.LINEAR_VERTICAL,dropShadow:!0,dropShadowColor:0,dropShadowDistance:3,dropShadowBlur:6}));F.anchor.set(.5,0),F.x=b.x+m/2,F.y=b.y+28,t.addChild(F);const j=new R(f?"The enemy has lost their will to fight.":"Your forces have been broken.",new O({fontFamily:"Georgia, serif",fontSize:16,fill:14540253,dropShadow:!0,dropShadowDistance:1,dropShadowBlur:3,dropShadowColor:0}));j.anchor.set(.5,0),j.x=b.x+m/2,j.y=b.y+100,t.addChild(j);const K=new H,xe=180,ze=46;function be(Fa){K.clear(),K.beginFill(Fa?15770880:12877568,1),K.drawRoundedRect(0,0,xe,ze,12),K.endFill()}be(!1),K.x=b.x+(m-xe)/2,K.y=b.y+158,K.eventMode="static",K.cursor="pointer",K.on("pointerover",()=>be(!0)),K.on("pointerout",()=>be(!1)),K.on("pointerdown",()=>window.location.reload());const Vt=new R("Play Again",new O({fontFamily:"Georgia, serif",fontSize:20,fontWeight:"bold",fill:16777215}));Vt.anchor.set(.5),Vt.x=xe/2,Vt.y=ze/2,K.addChild(Vt),t.addChild(K)}y.onDepleted=()=>Ne(!1),c.onDepleted=()=>Ne(!0),window.addEventListener("resize",()=>{i.x=a.screen.width/2,i.y=a.screen.height*.37,s.x=a.screen.width/2,s.y=a.screen.height*.63,n.x=a.screen.width*.3,n.y=a.screen.height*.13,l.x=a.screen.width*.3,l.y=a.screen.height*.88,T.x=a.screen.width/2,T.y=22,c.x=a.screen.width/2,c.y=66,x.x=a.screen.width/2,x.y=a.screen.height-66,y.x=a.screen.width/2,y.y=a.screen.height-22,Xe()});const La=_.endTurn.bind(_);_.endTurn=async function(){let f=null;if(_._isPlayerTurn){const g=s._placed.map(p=>p.cardView);g.length>0&&i._placed.length===0&&(f=()=>d.moraleBleed(g,c))}else{const g=i._placed.map(p=>p.cardView);g.length>0&&s._placed.length===0&&(f=()=>d.moraleBleed(g,y))}f&&await d.waitIdle(1500),f==null||f();for(const[g,p]of k)g.destroyed||(g.setAttack(p.attack),p.health!==null&&(g._maxHealth=p.maxHealth,g.setHealth(Math.min(p.health,g.card.health))));k.clear(),La(),_._isPlayerTurn?(x.nextTurn(),G(h,l),r.setCount(h.length)):(T.nextTurn(),ct(u),o.setCount(u.length),fa.onOpponentTurnStart())}}const Gi=320;function xt(a,t){return a+Math.random()*(t-a)}function ga(a){const t=a*.3;return Math.random()<.5?xt(0,t):xt(a-t,a)}class Bi extends z{constructor(t){super(),this._app=t,this._stars=[],this._build(),t.ticker.add(this._tick,this)}_build(){const t=this._app.screen.width,e=this._app.screen.height;for(let i=0;i<Gi;i++){const s=new H,n=xt(.5,2.2),l=xt(.3,1),r=xt(.08,.45),o=xt(.005,.022),h=xt(0,Math.PI*2),u=[16777215,14084863,16774348,13162751],_=u[Math.floor(Math.random()*u.length)];s.beginFill(_,l),s.drawCircle(0,0,n),s.endFill(),s.x=ga(t),s.y=xt(0,e),s._speed=r,s._baseAlpha=l,s._twinkleSpeed=o,s._twinkleOff=h,s._t=h,this.addChild(s),this._stars.push(s)}}_tick(t){const e=this._app.screen.height,i=this._app.screen.width;for(const s of this._stars)s.y+=s._speed*t,s.y>e+4&&(s.y=-4,s.x=ga(i)),s._t+=s._twinkleSpeed*t,s.alpha=s._baseAlpha*(.6+.4*Math.sin(s._t))}destroy(){this._app.ticker.remove(this._tick,this),super.destroy({children:!0})}}const Xi=55;function Q(a,t){return a+Math.random()*(t-a)}function ya(a){const t=a*.22;return Math.random()<.5?Q(0,t):Q(a-t,a)}function Ni(a,t,e){const i=new H;return i.beginFill(a,t),i.drawEllipse(0,0,e*.45,e),i.endFill(),i.lineStyle(.8,zi(a),t*.8),i.moveTo(0,-e),i.lineTo(0,e),i}function zi(a){const t=a>>16&255,e=a>>8&255,i=a&255;return t>>1<<16|e>>1<<8|i>>1}class Yi extends z{constructor(t){super(),this._app=t,this._leaves=[],this._build(),t.ticker.add(this._tick,this)}_build(){const t=this._app.screen.width,e=this._app.screen.height,i=[4881471,7907378,11059776,13936672,14711584,12599328,9124368,5934120];for(let s=0;s<Xi;s++){const n=i[Math.floor(Math.random()*i.length)],l=Q(.55,.9),r=Q(5,13),o=Ni(n,l,r);o.x=ya(t),o.y=Q(-e,e),o._fallSpeed=Q(.4,1.1),o._swayAmp=Q(8,28),o._swaySpeed=Q(.008,.022),o._swayOffset=Q(0,Math.PI*2),o._rotSpeed=Q(-.012,.012),o._t=o._swayOffset,o._baseX=o.x,o.rotation=Q(0,Math.PI*2),this.addChild(o),this._leaves.push(o)}}_tick(t){const e=this._app.screen.height,i=this._app.screen.width;for(const s of this._leaves)s.y+=s._fallSpeed*t,s._t+=s._swaySpeed*t,s.x=s._baseX+Math.sin(s._t)*s._swayAmp,s.rotation+=s._rotSpeed*t,s.y>e+20&&(s.y=Q(-40,-10),s._baseX=ya(i),s.x=s._baseX),s.x>i+20&&(s._baseX-=i+40),s.x<-20&&(s._baseX+=i+40)}destroy(){this._app.ticker.remove(this._tick,this),super.destroy({children:!0})}}function yt(a,t){return a+Math.random()*(t-a)}function ut(a,t,e){return a+(t-a)*e}function zt(a,t,e){return a<t?t:a>e?e:a}let Ee=Math.random()*1e3;function Wi(a){return Math.sin(a*1.7+Ee)*.5+Math.sin(a*3.1+Ee*.7)*.3+Math.sin(a*5.3+Ee*1.3)*.2}function qi(a){if(a>.78){const t=(a-.78)/.22;return{r:255,g:ut(240,255,t),b:ut(40,220,t),a:.85}}else if(a>.5){const t=(a-.5)/.28;return{r:255,g:ut(90,240,t),b:0,a}}else if(a>.22){const t=(a-.22)/.28;return{r:ut(170,255,t),g:ut(10,90,t),b:0,a:a*.85}}else return{r:100,g:15,b:0,a:a*.6}}function $i(a){const t=a>.5?1:a*2;return{r:255,g:ut(120,255,t),b:ut(0,180,t),a:zt(a*2.2,0,1)}}function Ui(a){return{r:255,g:ut(30,130,a),b:0,a:a*.22}}function ji({r:a,g:t,b:e}){return a<<16|t<<8|e}const ee={core:{count:90,maxLifeLo:.8,maxLifeHi:1.8,spawnX:18,spawnYLo:-4,spawnYHi:4,vyLo:-2.8,vyHi:-1.4,vxRange:.8,radiusLo:7,radiusHi:18,turbStrength:.14,widen:.6,blendMode:te.ADD},wisp:{count:40,maxLifeLo:.5,maxLifeHi:1.1,spawnX:10,spawnYLo:-25,spawnYHi:-8,vyLo:-1.2,vyHi:-.5,vxRange:1.2,radiusLo:3,radiusHi:9,turbStrength:.22,widen:.5,blendMode:te.ADD},ember:{count:28,maxLifeLo:.7,maxLifeHi:2.2,spawnX:20,spawnYLo:-5,spawnYHi:5,vyLo:-3.5,vyHi:-1,vxRange:2,radiusLo:1.5,radiusHi:3.5,turbStrength:.18,widen:1,blendMode:te.ADD},glow:{count:14,maxLifeLo:1,maxLifeHi:2,spawnX:26,spawnYLo:-10,spawnYHi:8,vyLo:-.8,vyHi:-.2,vxRange:.4,radiusLo:28,radiusHi:52,turbStrength:.06,widen:.8,blendMode:te.ADD}};class Ki{constructor(t,e){this.type=t,this.cfg=e,this.g=new H,this.g.blendMode=e.blendMode,this._noiseOffset=Math.random()*1e3,this.reset(!0)}reset(t=!1){const e=this.cfg;this._maxLife=yt(e.maxLifeLo,e.maxLifeHi),this._life=t?yt(0,this._maxLife):this._maxLife,this.g.x=yt(-e.spawnX,e.spawnX),this.g.y=yt(e.spawnYLo,e.spawnYHi),this._vx=yt(-e.vxRange,e.vxRange),this._vy=yt(e.vyLo,e.vyHi),this._radius=yt(e.radiusLo,e.radiusHi)}tick(t,e){if(this._life-=.013*t,this._life<=0){this.reset();return}const i=e*.018+this._noiseOffset,s=Wi(i)*this.cfg.turbStrength*this._radius;this._vx+=yt(-this.cfg.turbStrength,this.cfg.turbStrength)+s*.04,this._vx=zt(this._vx,-this.cfg.vxRange*1.6,this.cfg.vxRange*1.6),this.g.x+=this._vx*t,this.g.y+=this._vy*t,this.draw()}draw(){const t=zt(this._life/this._maxLife,0,1);let e;this.type==="glow"?e=Ui(t):this.type==="ember"?e=$i(t):e=qi(t);const i=this._radius*ut(this.cfg.widen,1.2,t);this.g.clear(),this.g.beginFill(ji(e),zt(e.a,0,1)),this.type==="ember"?this.g.drawCircle(0,0,i):this.type==="glow"?this.g.drawEllipse(0,0,i,i*.75):this.g.drawEllipse(0,0,i*.55,i),this.g.endFill(),this.g.alpha=zt(e.a,0,1)}}class Qi extends z{constructor(t,e=.82,i=.88){super(),this._app=t,this._anchorX=e,this._anchorY=i,this._time=0,this._particles=[],this._buildLayers(),this._reposition(),t.ticker.add(this._tick,this)}_buildLayers(){for(const[t,e]of[["glow",ee.glow],["core",ee.core],["wisp",ee.wisp],["ember",ee.ember]]){const i=new z;this.addChild(i);for(let s=0;s<e.count;s++){const n=new Ki(t,e);i.addChild(n.g),this._particles.push(n)}}}_reposition(){this.x=this._app.screen.width*this._anchorX,this.y=this._app.screen.height*this._anchorY}resize(){this._reposition()}_tick(t){this._time+=t,this.x=this._app.screen.width*this._anchorX,this.y=this._app.screen.height*this._anchorY;for(const e of this._particles)e.tick(t,this._time)}destroy(){this._app.ticker.remove(this._tick,this),super.destroy({children:!0})}}const Zi=""+new URL("BoardSpace-36611de0.png",import.meta.url).href;let it=null;async function Ji(){try{const a=await fetch("/CreatedCards/layout.json?t="+Date.now());if(!a.ok)return;it=await a.json(),za(it.animCardPlay,it.animCombat),Za(it.handLayoutConfig,it.handSlots,it.opponentHandSlots),$a(it.glowColors,it.glowInset,it.glowWidth)}catch{}}function Vi(){const a=it??{};try{const t=a.statLayout??null;if(t){const e=(n,l)=>({x:n?n.x/2-64:l.x,y:n?n.y/2-96:l.y}),i=t.hand??t,s=t.field??t;Object.assign(le,e(i.attack,le)),Object.assign(oe,e(i.health,oe)),Object.assign(re,e(i.name,re)),Object.assign(he,e(i.mana,he)),Object.assign(ce,e(i.faction,ce)),Object.assign(de,e(s.attack,de)),Object.assign(fe,e(s.health,fe)),Object.assign(ue,e(s.faction,ue)),i.factionIconSize&&(Me.size=i.factionIconSize/2)}}catch{}try{const t=a.fieldCircle??null;t&&(lt.cx=t.cx/2-64,lt.cy=t.cy/2-96,lt.r=t.r/2)}catch{}try{const t=a.handArtBox??null;t&&(I.x=t.x/2,I.y=t.y/2,I.w=t.w/2,I.h=t.h/2)}catch{}}const Ot=[{label:"Space",src:Zi,hasStars:!0,hasLeaves:!1,hasFire:!1},{label:"Forrest",src:Ra,hasStars:!1,hasLeaves:!0,hasFire:!0}];let Pe=1;const se=1280,ne=720,_t=new Ha({backgroundColor:0,antialias:!0,resolution:2,autoDensity:!0,width:se,height:ne}),bt=_t.view;bt.style.position="fixed";bt.style.top="0";bt.style.left="0";document.getElementById("app").appendChild(bt);const jt=new Lt(rt.from(Ot[1].src));jt.anchor.set(0,0);_t.stage.addChildAt(jt,0);const Ge=new Bi(_t),Be=new Yi(_t),ge=new Qi(_t,.836,.789);_t.stage.addChildAt(Ge,1);_t.stage.addChildAt(Be,2);_t.stage.addChildAt(ge,3);Ge.visible=Ot[1].hasStars;Be.visible=Ot[1].hasLeaves;ge.visible=Ot[1].hasFire;const ht=document.createElement("button");ht.textContent="🌍 Change Board";Object.assign(ht.style,{position:"fixed",top:"14px",right:"14px",zIndex:"999",padding:"8px 16px",background:"rgba(20,20,40,0.82)",color:"#f0e6c0",border:"1px solid rgba(255,220,100,0.5)",borderRadius:"8px",fontSize:"14px",fontFamily:"Georgia, serif",cursor:"pointer",backdropFilter:"blur(4px)",transition:"background 0.15s"});ht.addEventListener("mouseover",()=>{ht.style.background="rgba(60,50,10,0.92)"});ht.addEventListener("mouseout",()=>{ht.style.background="rgba(20,20,40,0.82)"});ht.addEventListener("click",()=>{Pe=(Pe+1)%Ot.length;const a=Ot[Pe];jt.texture=rt.from(a.src),Ge.visible=a.hasStars,Be.visible=a.hasLeaves,ge.visible=a.hasFire,ht.textContent="🌍 Change Board"});const wt=document.createElement("button");wt.textContent="✏️ Card Editor";const Qt={padding:"8px 16px",background:"rgba(20,20,40,0.82)",color:"#f0e6c0",border:"1px solid rgba(255,220,100,0.5)",borderRadius:"8px",fontSize:"14px",fontFamily:"Georgia, serif",cursor:"pointer",backdropFilter:"blur(4px)",transition:"background 0.15s"};Object.assign(wt.style,Qt);wt.addEventListener("mouseover",()=>{wt.style.background="rgba(60,50,10,0.92)"});wt.addEventListener("mouseout",()=>{wt.style.background="rgba(20,20,40,0.82)"});wt.addEventListener("click",()=>{window.location.href="/card-editor.html"});const Ct=document.createElement("button");Ct.textContent="✨ VFX Editor";Object.assign(Ct.style,Qt);Ct.addEventListener("mouseover",()=>{Ct.style.background="rgba(60,50,10,0.92)"});Ct.addEventListener("mouseout",()=>{Ct.style.background="rgba(20,20,40,0.82)"});Ct.addEventListener("click",()=>{window.location.href="/vfx-editor.html"});const Tt=document.createElement("button");Tt.textContent="🔊 Sounds";Object.assign(Tt.style,Qt);Tt.addEventListener("mouseover",()=>{Tt.style.background="rgba(10,40,60,0.92)"});Tt.addEventListener("mouseout",()=>{Tt.style.background="rgba(20,20,40,0.82)"});Tt.addEventListener("click",()=>{window.location.href="/sound-editor.html"});const vt=document.createElement("button");vt.textContent="⏱ Timeline";Object.assign(vt.style,Qt);vt.addEventListener("mouseover",()=>{vt.style.background="rgba(10,40,60,0.92)"});vt.addEventListener("mouseout",()=>{vt.style.background="rgba(20,20,40,0.82)"});vt.addEventListener("click",()=>{window.location.href="/animation-editor.html"});const at=document.createElement("button");M.mute(!0);at.textContent="🔇";at.title="Mute / Unmute sounds";Object.assign(at.style,{...Qt,padding:"6px 10px",minWidth:"36px",background:"rgba(80,10,10,0.92)"});at.addEventListener("mouseover",()=>{at.style.background="rgba(40,10,10,0.92)"});at.addEventListener("mouseout",()=>{at.style.background=M.isMuted?"rgba(80,10,10,0.92)":"rgba(20,20,40,0.82)"});at.addEventListener("click",()=>{M.mute(!M.isMuted),at.textContent=M.isMuted?"🔇":"🔊",at.style.background=M.isMuted?"rgba(80,10,10,0.92)":"rgba(20,20,40,0.82)"});const St=document.createElement("div");Object.assign(St.style,{position:"fixed",top:"14px",right:"14px",zIndex:"999",display:"flex",gap:"8px"});ht.style.position="static";St.appendChild(wt);St.appendChild(Ct);St.appendChild(Tt);St.appendChild(vt);St.appendChild(at);St.appendChild(ht);document.body.appendChild(St);function Aa(){const a=window.innerWidth/se,t=window.innerHeight/ne,e=Math.min(a,t),i=Math.round(se*e),s=Math.round(ne*e),n=Math.round((window.innerWidth-i)/2),l=Math.round((window.innerHeight-s)/2);bt.style.width=i+"px",bt.style.height=s+"px",bt.style.left=n+"px",bt.style.top=l+"px",jt.width=se,jt.height=ne,ge.resize()}window.addEventListener("resize",Aa);Aa();Promise.all([Ji(),N.syncFromFile(),M.loadAllCustom()]).finally(()=>{Vi(),Oi(_t)});
