import{C as R,G as w,d as D,a as I,T as q}from"./BoardForrest-927fe922.js";import{S as W}from"./SoundManager-7983c1fd.js";function N(d){return 1-Math.pow(1-d,3)}function H(d){return 1+2.70158*Math.pow(d-1,3)+1.70158*Math.pow(d-1,2)}const B=new WeakMap;function j(d){B.set(d,(B.get(d)??0)+1)}function u(d,e,i=220,s=N){const a=(B.get(d)??0)+1;B.set(d,a);const t={},n={};for(const c of Object.keys(e))t[c]=d[c]??0,n[c]=e[c]-t[c];const r=performance.now();return new Promise(c=>{function f(o){if(B.get(d)!==a){c();return}const l=Math.min((o-r)/i,1),_=s(l);for(const S of Object.keys(e))d[S]=t[S]+n[S]*_;l<1?requestAnimationFrame(f):c()}requestAnimationFrame(f)})}function U(d,e,i=320){return u(d,e,i,H)}function J(d,e,i=220){return u(d,e,i,s=>s*s*s)}function h(d,e){return d+Math.random()*(e-d)}const E={Folk:{ring:4508740,burst:8978278,flash:6750088},Wild:{ring:16737792,burst:16750848,flash:16763972},Magical:{ring:8930559,burst:13395711,flash:11197951}};function O(d){return typeof d=="number"?d:parseInt(String(d).replace("#",""),16)}class Q{constructor(e){this._app=e,this.container=new R,this._presetCache=null,this._factionPresetsSync={},this._specialPresetsSync={},this._active=0}_track(e){return this._active++,e.finally(()=>{this._active=Math.max(0,this._active-1)})}waitIdle(e=1500){return this._active===0?Promise.resolve():new Promise(i=>{const s=Date.now()+e,a=()=>{this._active===0||Date.now()>=s?i():requestAnimationFrame(a)};requestAnimationFrame(a)})}async _loadPresets(){if(this._presetCache)return this._presetCache;try{const e=await fetch("/CreatedCards/vfx-presets.json");e.ok?(this._presetCache=await e.json(),this._presetCache._factionPresets&&(this._factionPresetsSync=this._presetCache._factionPresets),this._presetCache._specialPresets&&(this._specialPresetsSync=this._presetCache._specialPresets)):this._presetCache={}}catch{this._presetCache={}}return this._presetCache}async _playSpecialPreset(e,i,s){var r;const a=this._specialPresetsSync[e];if(!a)return!1;const n=(await this._loadPresets())[a];return(r=n==null?void 0:n.steps)!=null&&r.length?(await this.playCustomEffect(n.steps,i,s),!0):!1}_hasSpecialPreset(e){return!!this._specialPresetsSync[e]}_getBoltConfig(e){const i=this._specialPresetsSync;return{color:i[e+"Color"]?O(i[e+"Color"]):null,size:i[e+"Size"]?Number(i[e+"Size"]):null,speed:i[e+"Speed"]?Number(i[e+"Speed"]):null,sprite:i[e+"Sprite"]||null,spriteScale:i[e+"SpriteScale"]?Number(i[e+"SpriteScale"]):1}}hasFactionPreset(e){return!!(e&&this._factionPresetsSync[e])}async playFactionPreset(e,i){var r,c;if(!e)return;const s=i.toGlobal({x:0,y:0}),a=await this._loadPresets(),t=(r=a._factionPresets)==null?void 0:r[e];if(!t)return;const n=a[t];if((c=n==null?void 0:n.steps)!=null&&c.length)return this._track(this.playCustomEffect(n.steps,s.x,s.y))}async playPreset(e,i){var n;if(!e)return;const s=i.toGlobal({x:0,y:0}),t=(await this._loadPresets())[e];if((n=t==null?void 0:t.steps)!=null&&n.length)return this._track(this.playCustomEffect(t.steps,s.x,s.y))}async clashAt(e,i,s=-Math.PI/2){const a=new w;a.beginFill(16777215,.92),a.drawCircle(0,0,48),a.endFill(),a.x=e,a.y=i,this.container.addChild(a),u(a,{alpha:0},180).then(()=>this._remove(a));const t=90;for(let r=0;r<4;r++){const c=s+r*Math.PI/2+h(-.18,.18),f=new w;f.lineStyle(h(2,4),16777215,1),f.moveTo(0,0),f.lineTo(Math.cos(c)*t*h(.7,1.3),Math.sin(c)*t*h(.7,1.3)),f.x=e,f.y=i,this.container.addChild(f),u(f,{alpha:0},h(180,280)).then(()=>this._remove(f))}const n=[];for(let r=0;r<28;r++){const c=r/28*Math.PI*2+h(-.25,.25),f=h(40,110),o=r%3===0?16766720:r%3===1?16746547:16777215,l=this._dot(h(2,6),o);l.x=e,l.y=i,this.container.addChild(l),n.push(l),u(l,{x:e+Math.cos(c)*f,y:i+Math.sin(c)*f,alpha:0},h(260,480))}this._shockwave(e,i,16766720,70,200),this.screenShake(5,180).catch(()=>{}),await m(500);for(const r of n)this._remove(r)}async burstAt(e,i,s=16763904,a=18){const t=[];for(let n=0;n<a;n++){const r=h(3,6),c=this._dot(r,s);c.x=e,c.y=i,this.container.addChild(c),t.push(c);const f=n/a*Math.PI*2+h(-.3,.3),o=h(28,65);u(c,{x:e+Math.cos(f)*o,y:i+Math.sin(f)*o,alpha:0},h(380,560))}await m(600);for(const n of t)this._remove(n)}async floatNumber(e,i,s,a=16729156){const t=new D(String(s),{fontFamily:'"Impact", sans-serif',fontSize:36,fontWeight:"bold",fill:a,stroke:0,strokeThickness:5,dropShadow:!0,dropShadowBlur:8,dropShadowColor:0,dropShadowAlpha:.85,dropShadowDistance:0});t.anchor.set(.5),t.x=e+h(-12,12),t.y=i,t.alpha=1,t.scale.set(.6),this.container.addChild(t);const n=Date.now(),r=900;return new Promise(c=>{const f=()=>{const o=Math.min(1,(Date.now()-n)/r),l=o<.18?o/.18:1;t.scale.set(.6+l*.6),t.y=i-o*75,t.alpha=o<.55?1:1-(o-.55)/.45,o<1?requestAnimationFrame(f):(this._remove(t),c())};requestAnimationFrame(f)})}async playCustomEffect(e,i,s){e!=null&&e.length&&await Promise.all(e.map(a=>m(a.delay??0).then(()=>this._runStep(a,i,s))))}async _runStep(e,i,s){const a=O(e.color??"#ffd700");switch(e.type){case"burst":{const t=e.count??18,n=[];for(let r=0;r<t;r++){const c=r/t*Math.PI*2+h(-.4,.4),f=h(e.minDist??30,e.maxDist??80),o=this._dot(h(e.minSize??3,e.maxSize??7),a);o.x=i,o.y=s,this.container.addChild(o),n.push(o),u(o,{x:i+Math.cos(c)*f,y:s+Math.sin(c)*f,alpha:0},e.duration??600)}await m((e.duration??600)+60);for(const r of n)this._remove(r);break}case"ring":await this._shockwave(i,s,a,e.radius??80,e.duration??280);break;case"shake":await this.screenShake(e.intensity??8,e.duration??300);break;case"flash":{const t=new w;t.beginFill(a,e.alpha??.6),t.drawRoundedRect(-66,-99,132,198,10),t.endFill(),t.x=i,t.y=s,this.container.addChild(t),await u(t,{alpha:0},e.duration??300),this._remove(t);break}case"text":{const t=new D(e.content??"!",{fontFamily:'"Impact", sans-serif',fontSize:e.size??58,fontWeight:"bold",fill:a,stroke:0,strokeThickness:6,dropShadow:!0,dropShadowBlur:12,dropShadowColor:0,dropShadowAlpha:1,dropShadowDistance:0});t.anchor.set(.5),t.x=i,t.y=s,t.alpha=0,t.scale.set(.3),this.container.addChild(t);const n=e.duration??700,r=e.riseY??80,c=Math.min(200,n*.25),f=n*.4,o=n-c-f,l=Date.now();await new Promise(_=>{const S=()=>{const y=Date.now()-l,P=Math.min(1,y/n);if(t.y=s-r*P,y<c)t.alpha=y/c,t.scale.set(.3+.7*(y/c));else if(y<c+f)t.alpha=1,t.scale.set(1);else{const M=(y-c-f)/o;t.alpha=Math.max(0,1-M),t.scale.set(1+M*.3)}P<1?requestAnimationFrame(S):(this._remove(t),_())};requestAnimationFrame(S)});break}case"rise":{const t=e.count??24,n=[];for(let r=0;r<t;r++){const c=this._dot(h(e.minSize??3,e.maxSize??8),a);c.x=i+h(-50,50),c.y=s+h(-20,20),this.container.addChild(c),n.push(c),u(c,{y:c.y-h(80,e.riseHeight??160),alpha:0},h(800,e.duration??1400))}await m(e.duration??1400);for(const r of n)this._remove(r);break}case"fire":{const t=e.count??40,n=e.duration??900,r=e.height??110,c=e.spread??28,f=[],o=n*.6;for(let l=0;l<t;l++){const _=l/t*o,S=h(n*.35,n*.8);setTimeout(()=>{const y=new w;y.x=i+h(-c,c),y.y=s+h(0,18);const P=y.x,M=y.y,x=h(-.45,.45);this.container.addChild(y),f.push(y);const v=Date.now(),A=()=>{const p=Math.min(1,(Date.now()-v)/S),g=1-p;let C=255,F,k,T;p<.25?(F=Math.round(220+35*(1-p/.25)),k=Math.round(80*(1-p/.25)),T=g):p<.55?(F=Math.round(220*(1-(p-.25)/.3)),k=0,T=g):p<.78?(C=Math.round(255-60*((p-.55)/.23)),F=0,k=0,T=g*.85):(C=Math.round(195-115*((p-.78)/.22)),F=0,k=0,T=g*.5);const G=(C&255)<<16|(F&255)<<8|k&255,z=h(4,10)*(.25+.75*g);y.clear(),y.beginFill(G,Math.max(0,T)),y.drawEllipse(0,0,z*.55,z),y.endFill(),y.x=P+x*(p*S/16),y.y=M-p*r*h(.85,1.15),p<1?requestAnimationFrame(A):this._remove(y)};requestAnimationFrame(A)},_)}await m(n+80);for(const l of f)this._remove(l);break}}}async testBolt(e,i,s,a,t="damageBolt"){const n=this._getBoltConfig(t),r=n.color??(t==="moraleBolt"?13373713:16737792),c=n.size??(t==="moraleBolt"?7:10),f=n.speed??(t==="moraleBolt"?380:320);let o;n.sprite?(o=new I(q.from(n.sprite)),o.anchor.set(.5),o.scale.set(n.spriteScale),o.rotation=Math.atan2(a-i,s-e)):(o=new w,o.beginFill(r,.95),o.drawCircle(0,0,c),o.endFill(),o.lineStyle(2,16777215,.45),o.drawCircle(0,0,Math.round(c*1.5))),o.x=e,o.y=i,this.container.addChild(o);const l=n.sprite?null:this._attachTrail(o,r,Math.max(3,Math.round(c*.6)));await u(o,{x:s,y:a},f),l&&clearInterval(l),this._remove(o),this._hasSpecialPreset(t)?await this._playSpecialPreset(t,s,a):(this._shockwave(s,a,r,55,200),this.screenShake(6,240).catch(()=>{}),await this.burstAt(s,a,r,20))}async projectile(e,i,s=16737792){const a=b(e),t=b(i),n=this._getBoltConfig("damageBolt"),r=n.color??s,c=n.size??10,f=n.speed??320;let o;n.sprite?(o=new I(q.from(n.sprite)),o.anchor.set(.5),o.scale.set(n.spriteScale),o.rotation=Math.atan2(t.y-a.y,t.x-a.x)):(o=new w,o.beginFill(r,.95),o.drawCircle(0,0,c),o.endFill(),o.lineStyle(2,16777215,.45),o.drawCircle(0,0,Math.round(c*1.5))),o.x=a.x,o.y=a.y,this.container.addChild(o);const l=n.sprite?null:this._attachTrail(o,r,Math.max(3,Math.round(c*.6)));await u(o,{x:t.x,y:t.y},f),l&&clearInterval(l),this._remove(o),this._hasSpecialPreset("damageBolt")?await this._playSpecialPreset("damageBolt",t.x,t.y):(this._shockwave(t.x,t.y,r,55,200),this.screenShake(6,240).catch(()=>{}),await this.burstAt(t.x,t.y,r,20))}async healSparkles(e){const i=b(e),s=[];for(let a=0;a<22;a++){const t=a/22*Math.PI*2,n=h(20,55),r=this._dot(h(4,9),a%3===0?11206604:4521864);r.x=i.x,r.y=i.y,this.container.addChild(r),s.push(r),u(r,{x:i.x+Math.cos(t)*n,y:i.y+Math.sin(t)*n,alpha:0},h(600,950))}for(let a=0;a<36;a++){const t=a<18?0:300,n=this._dot(h(3,8),a%4===0?16777215:a%2===0?11206604:4521864);n.x=i.x+h(-55,55),n.y=i.y+h(-30,30),n.alpha=1,this.container.addChild(n),s.push(n),setTimeout(()=>{u(n,{y:n.y-h(110,200),alpha:0},h(1100,1800))},t)}await m(2200);for(const a of s)this._remove(a)}moraleBleed(e,i){const s=this._getBoltConfig("moraleBolt"),a=s.color??13373713,t=s.size??7,n=s.speed??380;e.forEach((r,c)=>{setTimeout(()=>{const f=b(r),o=i.toGlobal({x:0,y:0});let l;s.sprite?(l=new I(q.from(s.sprite)),l.anchor.set(.5),l.scale.set(s.spriteScale),l.rotation=Math.atan2(o.y-f.y,o.x-f.x)):(l=new w,l.beginFill(a,.92),l.drawCircle(0,0,t),l.endFill(),l.lineStyle(1.5,16737894,.5),l.drawCircle(0,0,Math.round(t*1.57))),l.x=f.x,l.y=f.y,this.container.addChild(l);const _=s.sprite?null:this._attachTrail(l,a,Math.max(2,Math.round(t*.57)));u(l,{x:o.x,y:o.y},n).then(()=>{_&&clearInterval(_),this._remove(l),i.takeDamage(),this._hasSpecialPreset("moraleBolt")?this._playSpecialPreset("moraleBolt",o.x,o.y).catch(()=>{}):this.burstAt(o.x,o.y,a,10).catch(()=>{})})},c*160)})}async moraleRadial(e,i=16763904){const s=e.toGlobal({x:0,y:0});await this.burstAt(s.x,s.y,i,26)}async drainOrb(e,i){const s=e.toGlobal({x:0,y:0}),a=i.toGlobal({x:0,y:0}),t=new w;t.beginFill(6684825,.88),t.drawCircle(0,0,9),t.endFill(),t.lineStyle(2,13391359,.55),t.drawCircle(0,0,14),t.x=s.x,t.y=s.y,this.container.addChild(t);const n=this._attachTrail(t,11158783,5);await u(t,{x:a.x,y:a.y},480),clearInterval(n),this._remove(t),await this.burstAt(a.x,a.y,10027263,10)}async attackBuff(e,i=!0){const s=i?16755200:16720384,a=b(e),t=[];for(let n=0;n<18;n++){const r=h(8,18),c=new w;c.beginFill(s,h(.7,1)),c.drawRect(-2,-r,4,r),c.endFill(),c.x=a.x+h(-40,40),c.y=a.y+h(10,30),c.alpha=1,this.container.addChild(c),t.push(c),u(c,{y:c.y-h(60,100),alpha:0},h(450,700))}await m(750);for(const n of t)this._remove(n)}async summonFlash(e,i=null){return this._track(this._summonFlash(e,i))}async _summonFlash(e,i=null){const s=b(e),a=E[i]??{ring:16766720,burst:16766720,flash:16777215},t=new w;t.beginFill(a.flash,.65),t.drawRoundedRect(-66,-99,132,198,10),t.endFill(),t.x=s.x,t.y=s.y,t.alpha=.65,this.container.addChild(t),u(t,{alpha:0},140).then(()=>this._remove(t)),await this._shockwave(s.x,s.y,a.ring,85,130);const n=[];for(let r=0;r<30;r++){const c=r/30*Math.PI*2+h(-.2,.2),f=h(38,100),o=this._dot(h(3,8),r%3===0?16777215:a.burst);o.x=s.x,o.y=s.y,this.container.addChild(o),n.push(o),u(o,{x:s.x+Math.cos(c)*f,y:s.y+Math.sin(c)*f,alpha:0},h(200,340))}await m(380);for(const r of n)this._remove(r)}async _shockwave(e,i,s=16777215,a=80,t=240){const n=new w;n.x=e,n.y=i,this.container.addChild(n);const r=Date.now();return new Promise(c=>{const f=()=>{const o=Math.min(1,(Date.now()-r)/t),l=a*o;n.clear(),n.lineStyle(3*(1-o)+1,s,1-o),n.drawCircle(0,0,l),o<1?requestAnimationFrame(f):(this._remove(n),c())};requestAnimationFrame(f)})}async battlecryBurst(e,i=null){return this._track(this._battlecryBurst(e,i))}async _battlecryBurst(e,i=null){const s=b(e);if(W.play("battlecry"),this._hasSpecialPreset("battlecry")){await this._playSpecialPreset("battlecry",s.x,s.y);return}const a=E[i]??{ring:16755200,burst:16766720,flash:16766720};this._shockwave(s.x,s.y,a.ring,115,330);const t=new D("!",{fontFamily:'"Impact", sans-serif',fontSize:68,fontWeight:"bold",fill:a.burst,stroke:0,strokeThickness:6,dropShadow:!0,dropShadowBlur:12,dropShadowColor:0,dropShadowAlpha:1,dropShadowDistance:0});t.anchor.set(.5),t.x=s.x,t.y=s.y-20,t.alpha=0,t.scale.set(.3),this.container.addChild(t),u(t,{alpha:1,y:s.y-70},160);const n=Date.now(),r=()=>{const f=Math.min(1,(Date.now()-n)/160);t.scale.set(.3+.7*f),f<1&&requestAnimationFrame(r)};requestAnimationFrame(r),await m(270),u(t,{alpha:0,y:s.y-125},420).then(()=>this._remove(t));const c=[];for(let f=0;f<42;f++){const o=this._dot(h(2,7),f%4===0?16777215:f%2===0?a.ring:a.burst),l=f/42*Math.PI*2+h(-.4,.4),_=h(50,125);o.x=s.x,o.y=s.y,this.container.addChild(o),c.push(o),u(o,{x:s.x+Math.cos(l)*_,y:s.y+Math.sin(l)*_+h(0,40),alpha:0},h(500,820))}await m(880);for(const f of c)this._remove(f)}async screenShake(e=10,i=320){const s=this._app.stage,a=s.x,t=s.y,n=Date.now();return new Promise(r=>{const c=()=>{const o=(Date.now()-n)/i;if(o>=1){s.x=a,s.y=t,r();return}const l=e*(1-o);s.x=a+h(-l,l),s.y=t+h(-l,l),requestAnimationFrame(c)};requestAnimationFrame(c)})}async aoeBlast(e,i=16729088){this.screenShake(8,300),await Promise.all(e.map(async(s,a)=>{await m(a*60);const t=b(s);return this._shockwave(t.x,t.y,i,70,250),this._fireAt(t.x,t.y),this.burstAt(t.x,t.y,i,22)}))}_fireAt(e,i,s=38,a=100,t=22,n=820){const r=n*.55;for(let c=0;c<s;c++){const f=c/s*r,o=h(n*.35,n*.75);setTimeout(()=>{const l=new w;l.x=e+h(-t,t),l.y=i+h(0,16);const _=l.x,S=l.y,y=h(-.4,.4);this.container.addChild(l);const P=Date.now(),M=()=>{const x=Math.min(1,(Date.now()-P)/o),v=1-x;let A=255,p,g,C;x<.25?(p=Math.round(220+35*(1-x/.25)),g=Math.round(80*(1-x/.25)),C=v):x<.55?(p=Math.round(220*(1-(x-.25)/.3)),g=0,C=v):x<.78?(A=Math.round(255-60*((x-.55)/.23)),p=0,g=0,C=v*.85):(A=Math.round(195-115*((x-.78)/.22)),p=0,g=0,C=v*.5);const F=(A&255)<<16|(p&255)<<8|g&255,k=h(4,10)*(.25+.75*v);l.clear(),l.beginFill(F,Math.max(0,C)),l.drawEllipse(0,0,k*.55,k),l.endFill(),l.x=_+y*(x*o/16),l.y=S-x*a*h(.85,1.15),x<1?requestAnimationFrame(M):this._remove(l)};requestAnimationFrame(M)},f)}}async playDeathEffect(e,i,s){var t;const a=(e==null?void 0:e.deathVfxPreset)||this._specialPresetsSync.death;if(a){const r=(await this._loadPresets())[a];if((t=r==null?void 0:r.steps)!=null&&t.length){await this.playCustomEffect(r.steps,i,s);return}}await this._destroyEffectAt(i,s)}async _destroyEffectAt(e,i){this.screenShake(12,380),this._shockwave(e,i,2228224,50,140),await m(120);const s=[];for(let a=0;a<36;a++){const t=this._dot(h(3,10),a%3===0?1118481:a%2===0?16720384:16746496),n=a/36*Math.PI*2+h(-.3,.3),r=h(50,130);t.x=e,t.y=i,this.container.addChild(t),s.push(t),u(t,{x:e+Math.cos(n)*r,y:i+Math.sin(n)*r+h(10,45),alpha:0},h(500,900))}this._shockwave(e,i,16724736,110,350),await m(960);for(const a of s)this._remove(a)}async destroyEffect(e){const i=b(e);await this._destroyEffectAt(i.x,i.y)}_dot(e,i){const s=new w;return s.beginFill(i,1),s.drawCircle(0,0,e),s.endFill(),s}_attachTrail(e,i,s){return setInterval(()=>{if(!e.parent)return;const a=this._dot(s,i);a.x=e.x,a.y=e.y,a.alpha=.5,this.container.addChild(a),u(a,{alpha:0},180).then(()=>this._remove(a))},40)}_remove(e){e.parent&&e.parent.removeChild(e),e.destroy()}}function b(d){return d.toGlobal({x:0,y:0})}function m(d){return new Promise(e=>setTimeout(e,d))}export{Q as V,J as a,U as b,j as c,u as t};
